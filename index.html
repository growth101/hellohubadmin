<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alex Davis Care Group - Admin Dashboard</title>
    <link rel="icon" type="image/png" sizes="32x32" href="alex-davis-favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="alex-davis-favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="alex-davis-favicon.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 10px;
        }
        
        /* Login Screen Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            max-width: 400px;
            width: 100%;
        }
        
        .login-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        
        .login-logo {
            max-height: 60px;
            max-width: 200px;
            width: auto;
            height: auto;
            margin-bottom: 15px;
            object-fit: contain;
        }
        
        .login-header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 300;
        }
        
        .login-header p {
            opacity: 0.9;
            font-size: 14px;
            font-weight: 300;
        }
        
        .login-form {
            padding: 40px 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }
        
        .login-btn:active {
            transform: translateY(0);
        }
        .dashboard-container {
            max-width: 1200px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.98); border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15); overflow: hidden;
            backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2);
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white; padding: 30px 20px; text-align: center;
            position: relative; overflow: hidden;
        }
        .header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
        }
        .header .company-logo {
            max-height: 60px;
            max-width: 200px;
            width: auto;
            height: auto;
            margin-bottom: 15px;
            object-fit: contain;
        }
        .header h1 { font-size: 28px; margin-bottom: 8px; font-weight: 300; position: relative; z-index: 1; }
        .header p { opacity: 0.9; font-size: 14px; font-weight: 300; position: relative; z-index: 1; }
        .controls {
            padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
        }
        .btn {
            padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: 500; transition: all 0.3s ease; font-size: 13px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
            color: white; 
        }
        .btn-success { 
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%); 
            color: white; 
        }
        .btn-warning { 
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); 
            color: white; 
        }
        .btn:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 20px rgba(0,0,0,0.15); 
        }
        .btn:active { 
            transform: translateY(0); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        .stats {
            padding: 20px 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 20px 15px; border-radius: 12px; text-align: center;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        .stat-number { 
            font-size: 28px; font-weight: 600; color: #2c3e50; 
            margin-bottom: 6px; 
        }
        .stat-label { 
            color: #7f8c8d; font-size: 12px; font-weight: 500; 
            text-transform: uppercase; letter-spacing: 0.5px; 
        }
        .data-section { padding: 20px 15px; background: #ffffff; }
        .section-title { 
            font-size: 18px; font-weight: 600; margin-bottom: 15px; 
            color: #2c3e50; 
        }
        .visitor-table {
            width: 100%; border-collapse: collapse; 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
            border-radius: 12px; overflow: hidden; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }
        .visitor-table th, .visitor-table td {
            padding: 12px 8px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.06);
            font-size: 13px;
        }
        .visitor-table th {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white; font-weight: 600; font-size: 12px;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .visitor-table tr:hover { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%); 
        }
        .status-badge {
            padding: 4px 8px; border-radius: 16px; font-size: 10px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .status-arrived { 
            background: linear-gradient(135deg, #d4f6d4 0%, #c8e6c9 100%); 
            color: #2e7d32; border: 1px solid #a5d6a7; 
        }
        .status-departed { 
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); 
            color: #c62828; border: 1px solid #ef9a9a; 
        }
        .loading { 
            text-align: center; padding: 40px 20px; color: #7f8c8d; 
            font-size: 14px; font-weight: 300; 
        }
        .error { 
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); 
            color: #c62828; padding: 15px; border-radius: 10px; margin: 15px; 
            border: 1px solid #ef9a9a; font-size: 14px;
        }
        .filters {
            display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
            width: 100%;
        }
        .filter-input {
            padding: 8px 12px; border: 2px solid rgba(0,0,0,0.1); 
            border-radius: 8px; font-size: 13px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            transition: all 0.3s ease; min-width: 120px;
        }
        .filter-input:focus { 
            outline: none; border-color: #3498db; 
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
            background: #ffffff;
        }
        .recent-activity {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
            border-radius: 12px; padding: 20px 15px; margin-top: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .activity-item {
            padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.06); 
            display: flex; justify-content: space-between; align-items: center;
            transition: all 0.3s ease; font-size: 13px;
        }
        .activity-item:hover {
            padding-left: 8px;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.05) 0%, transparent 100%);
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-time { color: #7f8c8d; font-size: 11px; font-weight: 500; }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            body { padding: 5px; }
            
            .dashboard-container { border-radius: 16px; }
            
            .header { padding: 20px 15px; }
            .header h1 { font-size: 24px; }
            .header p { font-size: 13px; }
            
            .controls { 
                padding: 12px; 
                flex-direction: column; 
                align-items: stretch; 
                gap: 12px; 
            }
            
            .btn { 
                width: 100%; 
                padding: 12px; 
                font-size: 14px; 
                text-align: center; 
            }
            
            .filters { 
                flex-direction: column; 
                gap: 10px; 
                align-items: stretch; 
            }
            
            .filter-input { 
                width: 100%; 
                min-width: auto; 
                padding: 10px; 
            }
            
            .stats { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 12px; 
                padding: 15px 10px; 
            }
            
            .stat-card { padding: 15px 10px; }
            .stat-number { font-size: 24px; }
            .stat-label { font-size: 11px; }
            
            .data-section { padding: 15px 10px; }
            .section-title { font-size: 16px; }
            
            /* Mobile table - hide less important columns but keep contact info */
            .visitor-table th:nth-child(6),
            .visitor-table td:nth-child(6),
            .visitor-table th:nth-child(7),
            .visitor-table td:nth-child(7) {
                display: none;
            }
            
            .visitor-table th, .visitor-table td {
                padding: 8px 4px;
                font-size: 12px;
            }
            
            .visitor-table td:nth-child(10) button {
                padding: 6px 8px !important;
                font-size: 10px !important;
                margin-right: 3px !important;
                display: block !important;
                width: 100% !important;
                margin-bottom: 4px !important;
            }
            
            .recent-activity { padding: 15px 10px; }
            .activity-item { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 5px; 
                padding: 10px 0; 
            }
        }

        @media (max-width: 480px) {
            .stats { grid-template-columns: 1fr 1fr; }
            
            .visitor-table {
                font-size: 11px;
            }
            
            /* On very small screens, hide arrival/departure columns but keep contact */
            .visitor-table th:nth-child(6),
            .visitor-table td:nth-child(6),
            .visitor-table th:nth-child(7),
            .visitor-table td:nth-child(7) {
                display: none;
            }
            
            .status-badge {
                font-size: 9px;
                padding: 3px 6px;
            }
        }

        .feedback-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .feedback-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <img src="hellohub-admin-logo.png" alt="HelloHub Admin Logo" class="login-logo">
                <p>Admin Dashboard Access</p>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label for="adminEmail">Email Address:</label>
                    <input type="email" id="adminEmail" placeholder="Enter your admin email" onkeypress="if(event.key==='Enter') doAdminLogin()">
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter your password" onkeypress="if(event.key==='Enter') doAdminLogin()">
                </div>
                <button class="login-btn" onclick="doAdminLogin()">üîê Access Dashboard</button>
                <div id="loginError" style="display: none; color: #e74c3c; text-align: center; margin-top: 15px; font-size: 14px;"></div>
            </div>
        </div>
    </div>

    <div class="dashboard-container" id="dashboardContent" style="display: none;">
        <div class="header">
            <img src="alex-davis-logo.png" alt="Alex Davis Care Group Logo" class="company-logo">
            <h1>Alex Davis Care Group</h1>
            <p>üìä HelloHub Admin Dashboard</p>
            <p style="font-size: 13px; margin-top: 5px;">Real-time visitor management and analytics</p>
            <div style="position: absolute; top: 10px; right: 15px; font-size: 10px; opacity: 0.7;">
                Configured for: Alex Davis Care Group
            </div>
            <div style="position: absolute; top: 10px; left: 15px; font-size: 12px; opacity: 0.8;">
                <span onclick="logout()" style="cursor: pointer; padding: 5px 10px; background: rgba(255,255,255,0.2); border-radius: 15px; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">üö™ Logout</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="loadVisitorData()">üîÑ Refresh Data</button>
            <button class="btn btn-success" onclick="showAddVisitorForm()">‚ûï Add Visitor</button>
            <button class="btn btn-warning" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            <button class="btn btn-primary" onclick="exportFeedbackPDF()">üìä Export Feedback</button>
            
            <div class="filters">
                <input type="text" class="filter-input" id="searchFilter" placeholder="Search visitors..." onkeyup="filterData()">
                <select class="filter-input" id="locationFilter" onchange="filterData()">
                    <option value="">All Locations</option>
                    <option value="The Royal">The Royal</option>
                    <option value="The Crown">The Crown</option>
                    <option value="Seabreeze">Seabreeze</option>
                </select>
                <select class="filter-input" id="statusFilter" onchange="filterData()">
                    <option value="">All Status</option>
                    <option value="arrived">Arrived</option>
                    <option value="departed">Departed</option>
                </select>
            </div>
        </div>

        <!-- Add Visitor Modal -->
        <div id="addVisitorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;">
                <h3 style="margin-bottom: 20px; color: #333;">‚ûï Add Visitor Record</h3>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">First Name:</label>
                    <input type="text" id="modalFirstName" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Surname:</label>
                    <input type="text" id="modalSurname" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                    <input type="email" id="modalEmail" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mobile:</label>
                    <input type="tel" id="modalMobile" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">User Type:</label>
                    <select id="modalUserType" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="visitor">Visitor</option>
                        <option value="client">Client</option>
                        <option value="staff">Staff</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Location:</label>
                    <select id="modalLocation" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="The Royal">The Royal</option>
                        <option value="The Crown">The Crown</option>
                        <option value="Seabreeze">Seabreeze</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Status:</label>
                    <select id="modalStatus" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="arrived">Arrived</option>
                        <option value="departed">Departed</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="addVisitorRecord()" style="flex: 1;">‚úÖ Add Visitor</button>
                    <button class="btn" onclick="hideAddVisitorForm()" style="flex: 1; background: #6c757d; color: white;">‚ùå Cancel</button>
                </div>
            </div>
        </div>

        <!-- Feedback Details Modal -->
        <div id="feedbackModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;" onclick="closeFeedbackModal()">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #333; margin: 0;">üìã Visitor Feedback Details</h3>
                    <button onclick="closeFeedbackModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 5px; border-radius: 50%; transition: all 0.3s ease;" onmouseover="this.style.background='#f0f0f0'; this.style.color='#333';" onmouseout="this.style.background='none'; this.style.color='#999';">√ó</button>
                </div>
                <div id="feedbackContent">
                    <!-- Feedback details will be populated here -->
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn" onclick="closeFeedbackModal()" style="background: #6c757d; color: white;">Close</button>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalVisitors">-</div>
                <div class="stat-label">Total Visitors</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="currentlyInside">-</div>
                <div class="stat-label">Currently Inside</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayArrivals">-</div>
                <div class="stat-label">Today's Arrivals</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="averageVisitTime">-</div>
                <div class="stat-label">Avg Visit Time</div>
            </div>
        </div>

        <div class="data-section">
            <div class="section-title">üìã Visitor Log</div>
            <div id="dataDisplay" class="loading">
                Click "Refresh Data" to load visitor information
            </div>
        </div>

        <div class="recent-activity">
            <div class="section-title">üïí Recent Activity</div>
            <div id="recentActivity">
                <div class="activity-item">
                    <span>No recent activity</span>
                    <span class="activity-time">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global login state
        let isLoggedIn = false;
        let currentUser = null;

        const ADMIN_CONFIG = {
            // Supabase configuration
            supabaseUrl: 'https://obyzwhqaqyiqpeoefjgw.supabase.co',
            supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ieXp3aHFhcXlpcXBlb2Vmamd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDY0MDAsImV4cCI6MjA2NzU4MjQwMH0.NaePwt-LGqNp4vc8TTcv3IyzFkamZtiHmvDLpDcliAc',
            refreshInterval: 30000
        };

        // Login Functions
        function doAdminLogin() {
            const email = document.getElementById('adminEmail').value.trim().toLowerCase();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (!email || !password) {
                showLoginError('Please enter both email and password.');
                return;
            }
            
            // Use the same credentials as the visitor system
            if (email === 'office@alexdavis.co.uk' && password === 'office927') {
                // Clear form
                document.getElementById('adminEmail').value = '';
                document.getElementById('adminPassword').value = '';
                hideLoginError();
                
                // Set login state
                isLoggedIn = true;
                currentUser = {
                    email: email,
                    company: 'Alex Davis Care Group',
                    loginTime: new Date().toISOString()
                };
                
                // Save login session to localStorage (persistent across browser sessions)
                localStorage.setItem('hellohubAdminSession', JSON.stringify({
                    isLoggedIn: true,
                    user: currentUser,
                    sessionId: Date.now() // Unique session identifier
                }));
                
                // Mark this browser tab as active (session storage - clears on tab close)
                sessionStorage.setItem('hellohubAdminActive', 'true');
                
                showDashboard();
            } else {
                showLoginError('Invalid email or password.');
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideLoginError() {
            document.getElementById('loginError').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
            
            // Initialize dashboard
            loadVisitorData();
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function logout() {
            // Clear all session data
            localStorage.removeItem('hellohubAdminSession');
            sessionStorage.removeItem('hellohubAdminActive');
            
            // Reset state
            isLoggedIn = false;
            currentUser = null;
            
            // Show login screen
            showLogin();
        }

        function checkExistingSession() {
            const savedSession = localStorage.getItem('hellohubAdminSession');
            const isNewBrowserSession = !sessionStorage.getItem('hellohubAdminActive');
            
            // Mark this browser tab as active
            sessionStorage.setItem('hellohubAdminActive', 'true');
            
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    
                    if (sessionData.isLoggedIn && sessionData.user) {
                        if (isNewBrowserSession) {
                            // Fresh URL entry - could go either way, but let's keep them logged in for convenience
                            console.log('Fresh URL entry detected, but maintaining login session');
                        }
                        
                        // Restore session
                        isLoggedIn = true;
                        currentUser = sessionData.user;
                        showDashboard();
                        return;
                    }
                } catch (error) {
                    console.log('Invalid session data, showing login');
                }
            }
            
            // No valid session, show login
            showLogin();
        }

        let allVisitorData = JSON.parse(localStorage.getItem('hellohubVisitors') || '[]');
        let filteredData = [];

        function loadVisitorData() {
            document.getElementById('dataDisplay').innerHTML = '<div class="loading">üîÑ Loading visitor data...</div>';
            
            const refreshBtn = document.querySelector('button[onclick="loadVisitorData()"]');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '‚è≥ Loading...';
            refreshBtn.disabled = true;
            
            // Try Supabase database first, fallback to localStorage
            const loadFromSupabase = () => {
                console.log('Attempting to load from Supabase...');
                const url = `${ADMIN_CONFIG.supabaseUrl}/rest/v1/visitors?select=*&order=timestamp.desc`;
                console.log('Supabase URL:', url);
                
                return fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'apikey': ADMIN_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    }
                })
                .then(response => {
                    console.log('Supabase response status:', response.status);
                    console.log('Supabase response headers:', response.headers);
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.log('Supabase error response:', text);
                            throw new Error(`HTTP ${response.status}: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Raw Supabase data:', data);
                    console.log('üìä Loaded visitor data from Supabase:', data.length, 'records');
                    
                    // Convert Supabase format to our visitor format
                    return data.map(row => ({
                        timestamp: row.timestamp,
                        firstName: row.first_name || '',
                        surname: row.surname || '',
                        email: row.email || 'Not provided',
                        mobile: row.mobile || 'Not provided',
                        userType: row.user_type || 'visitor',
                        location: row.location || '',
                        arrivalDate: row.arrival_date || '',
                        arrivalTime: row.arrival_time || '',
                        departureDate: row.departure_date || '',
                        departureTime: row.departure_time || '',
                        status: row.status || 'arrived',
                        // Add feedback if it exists
                        ...(row.feedback_overall ? {
                            feedback: {
                                overall: row.feedback_overall || 0,
                                safety: row.feedback_safety || 0,
                                responsive: row.feedback_responsive || 0,
                                caring: row.feedback_caring || 0,
                                leadership: row.feedback_leadership || 0,
                                effectiveness: row.feedback_effectiveness || 0,
                                averageRating: row.feedback_average || 0,
                                additionalComments: row.feedback_comments || 'No additional comments'
                            }
                        } : {})
                    }));
                })
                .catch(error => {
                    console.error('Detailed Supabase error:', error);
                    throw error;
                });
            };
            
            const loadFromLocal = () => {
                console.log('üìÇ Loading from localStorage...');
                const rawData = localStorage.getItem('hellohubVisitors');
                return Promise.resolve(JSON.parse(rawData || '[]'));
            };
            
            // Try Supabase, fallback to localStorage
            loadFromSupabase()
                .catch(error => {
                    console.log('Supabase unavailable, using local data:', error.message);
                    return loadFromLocal();
                })
                .then(data => {
                    allVisitorData = data.map(visitor => ({
                        ...visitor,
                        timestamp: new Date(visitor.timestamp)
                    }));

                    // Sync to localStorage
                    localStorage.setItem('hellohubVisitors', JSON.stringify(allVisitorData));

                    displayVisitorData();
                    updateStats();
                    updateRecentActivity();
                    
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                })
                .catch(error => {
                    console.error('Failed to load data:', error);
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                    showMessage('‚ö†Ô∏è Could not load data. Please try again.', 'error');
                });
        }

        function showMessage(text, type = 'info') {
            const existingMsg = document.querySelector('.temp-message');
            if (existingMsg) existingMsg.remove();
            
            const message = document.createElement('div');
            message.className = 'temp-message';
            message.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1001;
                padding: 15px 20px; border-radius: 8px; font-weight: bold;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                transform: translateX(400px); transition: all 0.3s ease;
                ${type === 'success' ? 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;' : ''}
                ${type === 'info' ? 'background: #e3f2fd; color: #0277bd; border: 1px solid #b3e5fc;' : ''}
                ${type === 'error' ? 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;' : ''}
            `;
            message.textContent = text;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                message.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 300);
            }, 3000);
        }

        function saveVisitorData() {
            // Save to localStorage as backup
            localStorage.setItem('hellohubVisitors', JSON.stringify(allVisitorData));
            console.log('‚úÖ Data saved to localStorage');
            
            // Also save to Supabase - but this is more complex since we need to handle updates
            console.log('‚ÑπÔ∏è Supabase sync will happen when new visitors are added through the visitor app');
        }

        function showAddVisitorForm() {
            document.getElementById('addVisitorModal').style.display = 'block';
        }

        function hideAddVisitorForm() {
            document.getElementById('addVisitorModal').style.display = 'none';
            document.getElementById('modalFirstName').value = '';
            document.getElementById('modalSurname').value = '';
            document.getElementById('modalEmail').value = '';
            document.getElementById('modalMobile').value = '';
            document.getElementById('modalUserType').value = 'visitor';
            document.getElementById('modalLocation').value = 'The Royal';
            document.getElementById('modalStatus').value = 'arrived';
        }

        function addVisitorRecord() {
            const firstName = document.getElementById('modalFirstName').value.trim();
            const surname = document.getElementById('modalSurname').value.trim();
            
            if (!firstName || !surname) {
                showMessage('‚ùå Please enter both first name and surname.', 'error');
                return;
            }

            const now = new Date();
            const newVisitor = {
                timestamp: now.toISOString(),
                firstName: firstName,
                surname: surname,
                email: document.getElementById('modalEmail').value.trim() || 'Not provided',
                mobile: document.getElementById('modalMobile').value.trim() || 'Not provided',
                userType: document.getElementById('modalUserType').value,
                location: document.getElementById('modalLocation').value,
                arrivalDate: now.toLocaleDateString(),
                arrivalTime: now.toLocaleTimeString(),
                departureDate: document.getElementById('modalStatus').value === 'departed' ? now.toLocaleDateString() : '',
                departureTime: document.getElementById('modalStatus').value === 'departed' ? now.toLocaleTimeString() : '',
                status: document.getElementById('modalStatus').value
            };

            allVisitorData.unshift(newVisitor);
            saveVisitorData();
            hideAddVisitorForm();
            loadVisitorData();
            
            showMessage(`‚úÖ ${firstName} ${surname} has been added to the visitor log!`, 'success');
        }

        function displayVisitorData() {
            filteredData = [...allVisitorData];
            
            if (filteredData.length === 0) {
                document.getElementById('dataDisplay').innerHTML = 
                    '<div class="loading">No visitor data found. Use HelloHub check-in system or click "‚ûï Add Visitor" to add records.</div>';
                return;
            }

            let tableHTML = `
                <table class="visitor-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Contact</th>
                            <th>Arrival</th>
                            <th>Departure</th>
                            <th>Status</th>
                            <th>Feedback</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredData.forEach((visitor, index) => {
                const statusClass = visitor.status === 'arrived' ? 'status-arrived' : 'status-departed';
                const toggleAction = visitor.status === 'arrived' ? 'Check Out' : 'Check In';
                
                let feedbackHTML = '-';
                console.log('Checking visitor:', visitor.firstName, visitor.surname, 'Feedback:', visitor.feedback);
                
                if (visitor.feedback && visitor.userType === 'visitor') {
                    const avg = calculateAverageRating(visitor.feedback);
                    console.log('Average rating calculated:', avg);
                    feedbackHTML = `
                        <div style="text-align: center;">
                            <div style="color: #f39c12; font-weight: bold; margin-bottom: 4px;">
                                ${generateStars(avg)} <small>(${avg.toFixed(1)})</small>
                            </div>
                            <button class="btn" style="padding: 3px 8px; font-size: 10px; background: #17a2b8; color: white;" 
                                    onclick="showFeedbackDetails(${allVisitorData.indexOf(visitor)})">View Details</button>
                        </div>
                    `;
                } else if (visitor.userType === 'visitor' && visitor.status === 'departed') {
                    feedbackHTML = '<small style="color: #999;">No feedback provided</small>';
                }
                
                tableHTML += `
                    <tr>
                        <td>${new Date(visitor.timestamp).toLocaleTimeString()}</td>
                        <td><strong>${visitor.firstName} ${visitor.surname}</strong></td>
                        <td>${visitor.userType.charAt(0).toUpperCase() + visitor.userType.slice(1)}</td>
                        <td>${visitor.location}</td>
                        <td>${visitor.email}<br><small>${visitor.mobile}</small></td>
                        <td>${visitor.arrivalTime || '-'}</td>
                        <td>${visitor.departureTime || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${visitor.status.toUpperCase()}</span></td>
                        <td>${feedbackHTML}</td>
                        <td>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #17a2b8; color: white; margin-right: 5px;" 
                                    onclick="toggleVisitorStatus(${allVisitorData.indexOf(visitor)})">${toggleAction}</button>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #dc3545; color: white;" 
                                    onclick="deleteVisitor(${allVisitorData.indexOf(visitor)})">Delete</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            document.getElementById('dataDisplay').innerHTML = tableHTML;
        }

        function toggleVisitorStatus(index) {
            if (index >= 0 && index < allVisitorData.length) {
                const visitor = allVisitorData[index];
                const now = new Date();
                
                if (visitor.status === 'arrived') {
                    visitor.status = 'departed';
                    visitor.departureDate = now.toLocaleDateString();
                    visitor.departureTime = now.toLocaleTimeString();
                } else {
                    visitor.status = 'arrived';
                    visitor.departureDate = '';
                    visitor.departureTime = '';
                }
                
                saveVisitorData();
                loadVisitorData();
                alert(`‚úÖ ${visitor.firstName} ${visitor.surname} has been ${visitor.status === 'arrived' ? 'checked in' : 'checked out'}`);
            }
        }

        function deleteVisitor(index) {
            if (index >= 0 && index < allVisitorData.length) {
                const visitor = allVisitorData[index];
                if (confirm(`‚ö†Ô∏è Are you sure you want to delete ${visitor.firstName} ${visitor.surname}'s record?`)) {
                    allVisitorData.splice(index, 1);
                    saveVisitorData();
                    loadVisitorData();
                    alert(`üóëÔ∏è ${visitor.firstName} ${visitor.surname}'s record has been deleted.`);
                }
            }
        }

        function updateStats() {
            const total = allVisitorData.length;
            const currentlyInside = allVisitorData.filter(v => v.status === 'arrived').length;
            const today = new Date().toLocaleDateString();
            const todayArrivals = allVisitorData.filter(v => v.arrivalDate === today).length;

            document.getElementById('totalVisitors').textContent = total;
            document.getElementById('currentlyInside').textContent = currentlyInside;
            document.getElementById('todayArrivals').textContent = todayArrivals;
            document.getElementById('averageVisitTime').textContent = '2.5h';
        }

        function updateRecentActivity() {
            const recent = allVisitorData
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 5);

            let activityHTML = '';
            recent.forEach(visitor => {
                const action = visitor.status === 'arrived' ? 'checked in' : 'checked out';
                activityHTML += `
                    <div class="activity-item">
                        <span><strong>${visitor.firstName} ${visitor.surname}</strong> ${action} at ${visitor.location}</span>
                        <span class="activity-time">${visitor.timestamp.toLocaleTimeString()}</span>
                    </div>
                `;
            });

            if (activityHTML === '') {
                activityHTML = '<div class="activity-item"><span>No recent activity</span><span class="activity-time">-</span></div>';
            }

            document.getElementById('recentActivity').innerHTML = activityHTML;
        }

        function filterData() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredData = allVisitorData.filter(visitor => {
                const matchesSearch = searchTerm === '' || 
                    visitor.firstName.toLowerCase().includes(searchTerm) ||
                    visitor.surname.toLowerCase().includes(searchTerm) ||
                    visitor.email.toLowerCase().includes(searchTerm);

                const matchesLocation = locationFilter === '' || visitor.location === locationFilter;
                const matchesStatus = statusFilter === '' || visitor.status === statusFilter;

                return matchesSearch && matchesLocation && matchesStatus;
            });

            displayFilteredData(); // Use a separate function for filtered display
        }

        function displayFilteredData() {
            if (filteredData.length === 0) {
                document.getElementById('dataDisplay').innerHTML = 
                    '<div class="loading">No visitors match your filter criteria.</div>';
                return;
            }

            let tableHTML = `
                <table class="visitor-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Contact</th>
                            <th>Arrival</th>
                            <th>Departure</th>
                            <th>Status</th>
                            <th>Feedback</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredData.forEach((visitor, index) => {
                const statusClass = visitor.status === 'arrived' ? 'status-arrived' : 'status-departed';
                const toggleAction = visitor.status === 'arrived' ? 'Check Out' : 'Check In';
                
                let feedbackHTML = '-';
                console.log('Checking visitor:', visitor.firstName, visitor.surname, 'Feedback:', visitor.feedback);
                
                if (visitor.feedback && visitor.userType === 'visitor') {
                    const avg = calculateAverageRating(visitor.feedback);
                    console.log('Average rating calculated:', avg);
                    feedbackHTML = `
                        <div style="text-align: center;">
                            <div style="color: #f39c12; font-weight: bold; margin-bottom: 4px;">
                                ${generateStars(avg)} <small>(${avg.toFixed(1)})</small>
                            </div>
                            <button class="btn" style="padding: 3px 8px; font-size: 10px; background: #17a2b8; color: white;" 
                                    onclick="showFeedbackDetails(${allVisitorData.indexOf(visitor)})">View Details</button>
                        </div>
                    `;
                } else if (visitor.userType === 'visitor' && visitor.status === 'departed') {
                    feedbackHTML = '<small style="color: #999;">No feedback provided</small>';
                }
                
                tableHTML += `
                    <tr>
                        <td>${new Date(visitor.timestamp).toLocaleTimeString()}</td>
                        <td><strong>${visitor.firstName} ${visitor.surname}</strong></td>
                        <td>${visitor.userType.charAt(0).toUpperCase() + visitor.userType.slice(1)}</td>
                        <td>${visitor.location}</td>
                        <td>${visitor.email}<br><small>${visitor.mobile}</small></td>
                        <td>${visitor.arrivalTime || '-'}</td>
                        <td>${visitor.departureTime || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${visitor.status.toUpperCase()}</span></td>
                        <td>${feedbackHTML}</td>
                        <td>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #17a2b8; color: white; margin-right: 5px;" 
                                    onclick="toggleVisitorStatus(${allVisitorData.indexOf(visitor)})">${toggleAction}</button>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #dc3545; color: white;" 
                                    onclick="deleteVisitor(${allVisitorData.indexOf(visitor)})">Delete</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            document.getElementById('dataDisplay').innerHTML = tableHTML;
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear ALL visitor data? This cannot be undone!')) {
                allVisitorData = [];
                saveVisitorData();
                loadVisitorData();
                alert('üóëÔ∏è All visitor data has been cleared.');
            }
        }

        function calculateAverageRating(feedback) {
            const ratings = [
                feedback.overall,
                feedback.safety,
                feedback.responsive,
                feedback.caring,
                feedback.leadership,
                feedback.effectiveness
            ].filter(rating => rating > 0);
            
            if (ratings.length === 0) return 0;
            return ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length;
        }

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let stars = '';
            
            for (let i = 0; i < fullStars; i++) {
                stars += '‚≠ê';
            }
            if (hasHalfStar) {
                stars += '‚ú®';
            }
            
            return stars || '‚òÜ';
        }

        function showFeedbackDetails(visitorIndex) {
            const visitor = allVisitorData[visitorIndex];
            if (!visitor.feedback) return;
            
            const feedback = visitor.feedback;
            const avgRating = calculateAverageRating(feedback);
            
            const feedbackHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">${visitor.firstName} ${visitor.surname}</h4>
                    <div style="font-size: 24px; color: #f39c12; margin-bottom: 5px;">
                        ${generateStars(avgRating)}
                    </div>
                    <div style="color: #7f8c8d; font-size: 14px;">
                        Average Rating: ${avgRating.toFixed(1)} / 5.0
                    </div>
                </div>
                
                <div style="display: grid; gap: 15px;">
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Overall Experience:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.overall)} (${feedback.overall}/5)</span>
                    </div>
                    
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Keeps People Safe:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.safety)} (${feedback.safety}/5)</span>
                    </div>
                    
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Responsive to Needs:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.responsive)} (${feedback.responsive}/5)</span>
                    </div>
                    
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Caring Towards People:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.caring)} (${feedback.caring}/5)</span>
                    </div>
                    
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Well-Led:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.leadership)} (${feedback.leadership}/5)</span>
                    </div>
                    
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Effective Care:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.effectiveness)} (${feedback.effectiveness}/5)</span>
                    </div>
                    
                    ${feedback.additionalComments && feedback.additionalComments !== 'No additional comments' ? `
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                        <span style="font-weight: bold; color: #2c3e50;">Additional Comments:</span>
                        <p style="margin-top: 8px; color: #555; font-style: italic;">"${feedback.additionalComments}"</p>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('feedbackContent').innerHTML = feedbackHTML;
            document.getElementById('feedbackModal').style.display = 'block';
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'none';
        }

        function exportFeedbackPDF() {
            console.log('PDF export function called');
            
            const feedbackData = allVisitorData.filter(visitor => 
                visitor.userType === 'visitor' && visitor.feedback
            );
            
            console.log('Available feedback records for PDF:', feedbackData.length);
            
            if (feedbackData.length === 0) {
                showMessage('No feedback data found to export!', 'error');
                return;
            }
            
            // Generate CSV content instead of PDF for better compatibility
            const csvContent = generateFeedbackCSV(feedbackData);
            
            // Try to download as CSV file
            try {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `feedback-report-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage(`‚úÖ Exported ${feedbackData.length} feedback records as CSV!`, 'success');
            } catch (error) {
                console.error('Download failed:', error);
                // Fallback to showing the data
                showExportFallback(csvContent, feedbackData.length);
            }
        }

        function generateFeedbackCSV(feedbackData) {
            const headers = [
                'Date', 'Time', 'Visitor Name', 'Location', 'Email', 'Mobile',
                'Overall Rating', 'Safety Rating', 'Responsive Rating', 'Caring Rating', 
                'Leadership Rating', 'Effectiveness Rating', 'Average Rating', 'Additional Comments'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            feedbackData.forEach(visitor => {
                const feedback = visitor.feedback;
                const avgRating = calculateAverageRating(feedback);
                
                const row = [
                    new Date(visitor.timestamp).toLocaleDateString(),
                    new Date(visitor.timestamp).toLocaleTimeString(),
                    `"${visitor.firstName} ${visitor.surname}"`,
                    visitor.location,
                    visitor.email,
                    visitor.mobile,
                    feedback.overall,
                    feedback.safety,
                    feedback.responsive,
                    feedback.caring,
                    feedback.leadership,
                    feedback.effectiveness,
                    avgRating.toFixed(1),
                    `"${feedback.additionalComments || 'No comments'}"`
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            return csvContent;
        }

        function showExportFallback(csvContent, recordCount) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;
            `;
            
            content.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #333;">üìÑ Feedback Export (${recordCount} records)</h3>
                <p style="margin-bottom: 15px;">Copy this data and paste it into Excel or Google Sheets:</p>
                <textarea style="width: 100%; height: 300px; font-family: monospace; font-size: 12px; border: 1px solid #ccc; padding: 10px;" readonly>${csvContent}</textarea>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Close</button>
                    <button onclick="navigator.clipboard.writeText(\`${csvContent.replace(/`/g, '\\`')}\`).then(() => alert('Copied to clipboard!'))" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px;">Copy to Clipboard</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function silentRefresh() {
            // Check for updates from Google Sheets every 30 seconds (silent, no errors shown)
            fetch(ADMIN_CONFIG.googleSheetsJsonUrl, {
                method: 'GET',
                mode: 'cors'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.text();
                })
                .then(text => {
                    // Parse Google Sheets JSONP response
                    const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/);
                    if (!jsonMatch) {
                        throw new Error('Invalid response format');
                    }
                    
                    const data = JSON.parse(jsonMatch[1]);
                    const visitors = [];
                    
                    if (data.table && data.table.rows) {
                        data.table.rows.forEach(row => {
                            if (row.c && row.c.length >= 12) {
                                const visitor = {
                                    timestamp: row.c[0]?.v || new Date().toISOString(),
                                    firstName: row.c[1]?.v || '',
                                    surname: row.c[2]?.v || '',
                                    email: row.c[3]?.v || 'Not provided',
                                    mobile: row.c[4]?.v || 'Not provided',
                                    userType: row.c[5]?.v || 'visitor',
                                    location: row.c[6]?.v || '',
                                    arrivalDate: row.c[7]?.v || '',
                                    arrivalTime: row.c[8]?.v || '',
                                    departureDate: row.c[9]?.v || '',
                                    departureTime: row.c[10]?.v || '',
                                    status: row.c[11]?.v || 'arrived'
                                };
                                
                                // Add feedback data if available
                                if (row.c.length >= 20 && row.c[12]?.v) {
                                    visitor.feedback = {
                                        overall: parseInt(row.c[12]?.v) || 0,
                                        safety: parseInt(row.c[13]?.v) || 0,
                                        responsive: parseInt(row.c[14]?.v) || 0,
                                        caring: parseInt(row.c[15]?.v) || 0,
                                        leadership: parseInt(row.c[16]?.v) || 0,
                                        effectiveness: parseInt(row.c[17]?.v) || 0,
                                        averageRating: parseFloat(row.c[18]?.v) || 0,
                                        additionalComments: row.c[19]?.v || 'No additional comments'
                                    };
                                }
                                
                                visitors.push(visitor);
                            }
                        });
                    }
                    
                    if (visitors.length !== allVisitorData.length) {
                        console.log('üìä Data updated from Google Sheets');
                        
                        allVisitorData = visitors.map(visitor => ({
                            ...visitor,
                            timestamp: new Date(visitor.timestamp)
                        }));
                        
                        // Update localStorage backup
                        localStorage.setItem('hellohubVisitors', JSON.stringify(allVisitorData));
                        
                        displayVisitorData();
                        updateStats();
                        updateRecentActivity();
                    }
                })
                .catch(error => {
                    // Silent fail - just use local data
                    console.log('Silent refresh from sheets failed, continuing with local data');
                });
        }

        setInterval(() => silentRefresh(), ADMIN_CONFIG.refreshInterval);

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè¢ Admin Dashboard initialized');
            
            // Check for existing session first
            checkExistingSession();
        });
    </script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const supabase = supabase.createClient(
    'https://obyzwhqaqyiqpeoefjgw.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ieXp3aHFhcXlpcXBlb2Vmamd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDY0MDAsImV4cCI6MjA2NzU4MjQwMH0.NaePwt-LGqNp4vc8TTcv3IyzFkamZtiHmvDLpDcliAc'
  );

  async function loadVisitorData() {
    const container = document.getElementById('dataDisplay');
    if (!container) return;
    container.innerHTML = '<div class="loading">Loading visitor data...</div>';

    const { data, error } = await supabase
      .from('visitors')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      container.innerHTML = `<div class="error">Failed to load visitor data.</div>`;
      console.error(error);
      return;
    }

    if (!data || data.length === 0) {
      container.innerHTML = `<div class="loading">No visitor data found.</div>`;
      return;
    }

    let html = `<table class="visitor-table"><thead><tr>
      <th>First Name</th><th>Surname</th><th>Email</th><th>Mobile</th>
      <th>User Type</th><th>Location</th><th>Status</th><th>Created</th>
    </tr></thead><tbody>`;

    data.forEach(row => {
      html += `<tr>
        <td>${row.first_name || ''}</td>
        <td>${row.surname || ''}</td>
        <td>${row.email || ''}</td>
        <td>${row.mobile || ''}</td>
        <td>${row.user_type || ''}</td>
        <td>${row.location || ''}</td>
        <td>${row.status || ''}</td>
        <td>${new Date(row.created_at).toLocaleString()}</td>
      </tr>`;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
  }
</script>

</body>
</html>

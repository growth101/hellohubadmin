<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alex Davis Care Group - Admin Dashboard</title>
    <link rel="icon" type="image/png" sizes="32x32" href="alex-davis-favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="alex-davis-favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="alex-davis-favicon.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 10px;
        .btn:active { 
            transform: translateY(0); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }

        // DEBUG FUNCTIONS TO IDENTIFY THE MISMATCH
        async function debugDatabaseSchema() {
            console.log('üîç Starting database schema analysis...');
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 800px; height: 80%; overflow-y: auto;';
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>üîç Database Schema Analysis</h3>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                            style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Close</button>
                </div>
                <div id="schemaResults">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 16px;">üîÑ Analyzing database schema...</div>
                        <div style="font-size: 14px; color: #666; margin-top: 10px;">This will help identify column name mismatches</div>
                    </div>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Analyze schema
            const possibleTables = ['visitors', 'visitor_log', 'hellohub_visitors', 'visitor_data', 'visitors'];
            let results = '<div style="font-family: monospace; font-size: 12px;">';
            
            for (const tableName of possibleTables) {
                try {
                    results += `<h4 style="color: #2c3e50; margin-top: 20px;">üìä Table: ${tableName}</h4>`;
                    
                    // Try to get sample data to see the actual structure
                    const response = await fetch(`${ADMIN_CONFIG.supabaseUrl}/rest/v1/${tableName}?limit=3`, {
                        method: 'GET',
                        headers: {
                            'apikey': ADMIN_CONFIG.supabaseAnonKey,
                            'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.length > 0) {
                            results += `<div style="color: #27ae60; margin: 5px 0;">‚úÖ Table exists with ${data.length} sample records</div>`;
                            
                            // Show column structure
                            const columns = Object.keys(data[0]);
                            results += `<div style="margin: 10px 0;"><strong>Columns found (${columns.length}):</strong></div>`;
                            results += `<div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px;">`;
                            columns.forEach(col => {
                                const sampleValue = data[0][col];
                                const valueType = typeof sampleValue;
                                results += `<div>‚Ä¢ <strong>${col}</strong>: ${valueType} = "${sampleValue}"</div>`;
                            });
                            results += `</div>`;
                            
                            // Show what the dashboard expects vs what exists
                            results += `<div style="margin: 10px 0;"><strong>Dashboard Field Mapping:</strong></div>`;
                            results += `<div style="background: #fff3cd; padding: 10px; margin: 5px 0; border-radius: 5px;">`;
                            const expectedMappings = {
                                'firstName': ['first_name', 'firstName', 'visitor_name'],
                                'surname': ['surname', 'lastName', 'last_name'],
                                'email': ['email', 'visitor_email'],
                                'mobile': ['mobile', 'phone', 'visitor_phone'],
                                'userType': ['user_type', 'type', 'visitor_type'],
                                'location': ['location', 'site', 'facility'],
                                'arrivalDate': ['arrival_date', 'arrival_date'],
                                'arrivalTime': ['arrival_time', 'arrival_time'],
                                'departureDate': ['departure_date', 'departure_date'],
                                'departureTime': ['departure_time', 'departure_time:']
                            };
                            
                            Object.entries(expectedMappings).forEach(([field, possibilities]) => {
                                const found = possibilities.find(p => columns.includes(p));
                                if (found) {
                                    results += `<div style="color: #27ae60;">‚úÖ ${field} ‚Üí ${found}</div>`;
                                } else {
                                    results += `<div style="color: #e74c3c;">‚ùå ${field} ‚Üí No match found (expects: ${possibilities.join(', ')})</div>`;
                                }
                            });
                            results += `</div>`;
                            
                            // Show recent records
                            results += `<div style="margin: 10px 0;"><strong>Sample Records:</strong></div>`;
                            results += `<div style="background: #e3f2fd; padding: 10px; margin: 5px 0; border-radius: 5px; max-height: 200px; overflow-y: auto;">`;
                            data.forEach((record, index) => {
                                results += `<div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #ccc;"><strong>Record ${index + 1}:</strong><br>`;
                                results += `<pre style="font-size: 11px; margin: 5px 0;">${JSON.stringify(record, null, 2)}</pre></div>`;
                            });
                            results += `</div>`;
                            
                        } else {
                            results += `<div style="color: #f39c12; margin: 5px 0;">‚ö†Ô∏è Table exists but is empty</div>`;
                            
                            // Try to get column info from empty table (this might not work in all cases)
                            results += `<div style="color: #666; margin: 5px 0;">Cannot determine column structure from empty table</div>`;
                        }
                    } else if (response.status === 404) {
                        results += `<div style="color: #6c757d; margin: 5px 0;">üìù Table does not exist</div>`;
                    } else {
                        const errorText = await response.text();
                        results += `<div style="color: #e74c3c; margin: 5px 0;">‚ùå Error: ${response.status} - ${errorText}</div>`;
                    }
                } catch (error) {
                    results += `<div style="color: #e74c3c; margin: 5px 0;">‚ùå Error accessing table: ${error.message}</div>`;
                }
            }
            
            results += '</div>';
            document.getElementById('schemaResults').innerHTML = results;
        }

        async function showRawDatabaseData() {
            console.log('üìã Fetching raw database data...');
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 1000px; height: 80%; overflow-y: auto;';
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>üìã Raw Database Data</h3>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                            style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Close</button>
                </div>
                <div id="rawDataResults">
                    <div style="text-align: center; padding: 20px;">üîÑ Loading raw data...</div>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Get raw data from all tables
            const possibleTables = ['visitors', 'visitor_log', 'hellohub_visitors', 'visitor_data', 'visitors'];
            let results = '';
            
            for (const tableName of possibleTables) {
                try {
                    const response = await fetch(`${ADMIN_CONFIG.supabaseUrl}/rest/v1/${tableName}?order=created_at.desc&limit=10`, {
                        method: 'GET',
                        headers: {
                            'apikey': ADMIN_CONFIG.supabaseAnonKey,
                            'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        results += `<h4>üìä Table: ${tableName} (${data.length} records)</h4>`;
                        
                        if (data.length > 0) {
                            results += `<div style="background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; margin: 10px 0; overflow-x: auto;">`;
                            results += `<pre style="margin: 0; font-size: 11px; white-space: pre-wrap;">${JSON.stringify(data, null, 2)}</pre>`;
                            results += `</div>`;
                        } else {
                            results += `<div style="color: #6c757d; margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">No data in this table</div>`;
                        }
                    } else if (response.status !== 404) {
                        results += `<h4>‚ùå Table: ${tableName} - Error ${response.status}</h4>`;
                    }
                } catch (error) {
                    results += `<h4>‚ùå Table: ${tableName} - ${error.message}</h4>`;
                }
            }
            
            if (!results) {
                results = '<div style="text-align: center; padding: 40px; color: #6c757d;">No accessible tables found</div>';
            }
            
            document.getElementById('rawDataResults').innerHTML = results;
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            max-width: 400px;
            width: 100%;
        }
        
        .login-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        
        .login-logo {
            max-height: 60px;
            max-width: 200px;
            width: auto;
            height: auto;
            margin-bottom: 15px;
            object-fit: contain;
        }
        
        .login-header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 300;
        }
        
        .login-header p {
            opacity: 0.9;
            font-size: 14px;
            font-weight: 300;
        }
        
        .login-form {
            padding: 40px 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }
        
        .login-btn:active {
            transform: translateY(0);
        }
        
        .dashboard-container {
            max-width: 1200px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.98); border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15); overflow: hidden;
            backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2);
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white; padding: 30px 20px; text-align: center;
            position: relative; overflow: hidden;
        }
        
        .header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
        }
        
        .header .company-logo {
            max-height: 60px;
            max-width: 200px;
            width: auto;
            height: auto;
            margin-bottom: 15px;
            object-fit: contain;
        }
        
        .header h1 { font-size: 28px; margin-bottom: 8px; font-weight: 300; position: relative; z-index: 1; }
        .header p { opacity: 0.9; font-size: 14px; font-weight: 300; position: relative; z-index: 1; }
        
        .controls {
            padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: 500; transition: all 0.3s ease; font-size: 13px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); flex-shrink: 0;
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
            color: white; 
        }
        
        .btn-success { 
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%); 
            color: white; 
        }
        
        .btn-warning { 
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); 
            color: white; 
        }
        
        .btn:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 20px rgba(0,0,0,0.15); 
        }
        
        .btn-debug {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
        }
        
        .stats {
            padding: 20px 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 20px 15px; border-radius: 12px; text-align: center;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .stat-number { 
            font-size: 28px; font-weight: 600; color: #2c3e50; 
            margin-bottom: 6px; 
        }
        
        .stat-label { 
            color: #7f8c8d; font-size: 12px; font-weight: 500; 
            text-transform: uppercase; letter-spacing: 0.5px; 
        }
        
        .data-section { padding: 20px 15px; background: #ffffff; }
        
        .section-title { 
            font-size: 18px; font-weight: 600; margin-bottom: 15px; 
            color: #2c3e50; 
        }
        
        .visitor-table {
            width: 100%; border-collapse: collapse; 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
            border-radius: 12px; overflow: hidden; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }
        
        .visitor-table th, .visitor-table td {
            padding: 12px 8px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.06);
            font-size: 13px;
        }
        
        .visitor-table th {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white; font-weight: 600; font-size: 12px;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        
        .visitor-table tr:hover { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%); 
        }
        
        .status-badge {
            padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
            display: inline-flex; align-items: center; gap: 4px;
            white-space: nowrap;
        }
        
        .status-arrived { 
            background: linear-gradient(135deg, #d4f6d4 0%, #c8e6c9 100%); 
            color: #2e7d32; border: 1px solid #a5d6a7; 
        }
        
        .status-departed { 
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); 
            color: #c62828; border: 1px solid #ef9a9a; 
        }
        
        .loading { 
            text-align: center; padding: 40px 20px; color: #7f8c8d; 
            font-size: 14px; font-weight: 300; 
        }
        
        .error { 
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); 
            color: #c62828; padding: 15px; border-radius: 10px; margin: 15px; 
            border: 1px solid #ef9a9a; font-size: 14px;
        }
        
        .filters {
            display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
            width: 100%;
        }
        
        .filter-input {
            padding: 8px 12px; border: 2px solid rgba(0,0,0,0.1); 
            border-radius: 8px; font-size: 13px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            transition: all 0.3s ease; min-width: 120px;
        }
        
        .filter-input:focus { 
            outline: none; border-color: #3498db; 
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
            background: #ffffff;
        }
        
        .recent-activity {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
            border-radius: 12px; padding: 20px 15px; margin-top: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .activity-item {
            padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.06); 
            display: flex; justify-content: space-between; align-items: center;
            transition: all 0.3s ease; font-size: 13px;
        }
        
        .activity-item:hover {
            padding-left: 8px;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.05) 0%, transparent 100%);
        }
        
        .activity-item:last-child { border-bottom: none; }
        .activity-time { color: #7f8c8d; font-size: 11px; font-weight: 500; }

        .feedback-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .feedback-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            body { padding: 5px; }
            .dashboard-container { border-radius: 16px; }
            .header { padding: 20px 15px; }
            .header h1 { font-size: 24px; }
            .header p { font-size: 13px; }
            .controls { 
                padding: 12px; 
                flex-direction: column; 
                align-items: stretch; 
                gap: 12px; 
            }
            .btn { 
                width: 100%; 
                padding: 12px; 
                font-size: 14px; 
                text-align: center; 
            }
            .filters { 
                flex-direction: column; 
                gap: 10px; 
                align-items: stretch; 
            }
            .filter-input { 
                width: 100%; 
                min-width: auto; 
                padding: 10px; 
            }
            .stats { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 12px; 
                padding: 15px 10px; 
            }
            .stat-card { padding: 15px 10px; }
            .stat-number { font-size: 24px; }
            .stat-label { font-size: 11px; }
            .data-section { padding: 15px 10px; }
            .section-title { font-size: 16px; }
            .visitor-table th, .visitor-table td {
                padding: 8px 4px;
                font-size: 12px;
            }
            .recent-activity { padding: 15px 10px; }
            .activity-item { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 5px; 
                padding: 10px 0; 
            }
        }

        
        // CHECK OUT VISITOR FUNCTIONALITY
        function checkOutVisitor(visitorIndex) {
            const visitor = allVisitorData[visitorIndex];
            
            if (visitor.departureTime) {
                showNotification('‚ùå This visitor has already checked out.', 'error');
                return;
            }
            
            // Confirmation dialog
            const confirmMessage = `Check out ${visitor.firstName} ${visitor.surname}?
            
This will mark them as having left ${visitor.location} and update their status to "LEFT".
            
Continue with checkout?`;
            
            if (confirm(confirmMessage)) {
                // Show checkout time selection modal
                showCheckOutModal(visitor, visitorIndex);
            }
        }

        function showCheckOutModal(visitor, visitorIndex) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            const formContainer = document.createElement('div');
            formContainer.style.cssText = 'background: white; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 25px 50px rgba(0,0,0,0.3);';
            
            // Get current date and time for defaults
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            
            formContainer.innerHTML = `
                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px;">üö™ Check Out Visitor</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" 
                                style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; border-radius: 50%; opacity: 0.8; transition: opacity 0.3s;" 
                                onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">√ó</button>
                    </div>
                    <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 14px;">Set departure time for <strong>${visitor.firstName} ${visitor.surname}</strong></p>
                </div>
                
                <div style="padding: 25px;">
                    <form id="checkOutForm">
                        <div style="margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                    <div><strong>Name:</strong> ${visitor.firstName} ${visitor.surname}</div>
                                    <div><strong>Location:</strong> ${visitor.location}</div>
                                    <div><strong>Arrived:</strong> ${visitor.arrivalDate} ${visitor.arrivalTime}</div>
                                    <div><strong>User Type:</strong> ${visitor.userType}</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Departure Date *</label>
                                    <input type="date" id="checkoutDate" required value="${currentDate}" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Departure Time *</label>
                                    <input type="time" id="checkoutTime" required value="${currentTime}" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <small style="color: #666; font-size: 12px;">
                                    üí° Tip: Departure time defaults to now, but you can adjust it if needed
                                </small>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="button" onclick="this.parentElement.parentElement.parentElement.parentElement.parentElement.remove()" 
                                    style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                Cancel
                            </button>
                            <button type="submit" 
                                    style="flex: 2; padding: 12px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                üö™ Check Out
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            modal.appendChild(formContainer);
            document.body.appendChild(modal);
            
            // Focus on time field
            document.getElementById('checkoutTime').focus();
            
            // Add form styling on focus
            const inputs = formContainer.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.style.borderColor = '#e74c3c';
                    this.style.boxShadow = '0 0 0 3px rgba(231, 76, 60, 0.1)';
                });
                input.addEventListener('blur', function() {
                    this.style.borderColor = '#e0e0e0';
                    this.style.boxShadow = 'none';
                });
            });
            
            // Handle form submission
            document.getElementById('checkOutForm').addEventListener('submit', function(e) {
                e.preventDefault();
                processCheckOut(visitor, visitorIndex); // Back to original name
            });
        }

        // COMPLETELY NEW CHECKOUT FUNCTION - ONLY VISITORS TABLE
        async function processCheckOutNew(visitor, visitorIndex) {
            console.log('üÜï Using NEW checkout function - only visitors table');
            
            try {
                const departureDate = document.getElementById('checkoutDate').value;
                const departureTime = document.getElementById('checkoutTime').value;
                
                if (!departureDate || !departureTime) {
                    showNotification('‚ùå Please provide both departure date and time.', 'error');
                    return;
                }
                
                // Validate that departure is not before arrival
                const arrivalDateTime = new Date(`${visitor.arrivalDate} ${visitor.arrivalTime}`);
                const departureDateTime = new Date(`${departureDate} ${departureTime}`);
                
                if (departureDateTime < arrivalDateTime) {
                    showNotification('‚ùå Departure time cannot be before arrival time.', 'error');
                    return;
                }
                
                // Show loading state
                const submitBtn = document.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '‚è≥ Checking Out...';
                submitBtn.disabled = true;
                
                console.log(`üö™ NEW: Processing checkout for ${visitor.firstName} ${visitor.surname} (ID: ${visitor.id})`);
                
                // Only the exact fields that exist in visitors table
                const updateData = {
                    departure_date: departureDate,
                    departure_time: departureTime,
                    status: 'departed'
                };
                
                console.log('üì§ NEW: Sending to visitors table only:', updateData);
                
                // ONLY update visitors table - no loops, no other tables
                const response = await fetch(`${ADMIN_CONFIG.supabaseUrl}/rest/v1/visitors?id=eq.${visitor.id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': ADMIN_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(updateData)
                });
                
                console.log(`üì° NEW: visitors table response: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    console.log(`‚úÖ NEW: Successfully updated visitor in visitors table`);
                    
                    // Update local data
                    allVisitorData[visitorIndex].departureDate = departureDate;
                    allVisitorData[visitorIndex].departureTime = departureTime;
                    allVisitorData[visitorIndex].status = 'departed';
                    allVisitorData[visitorIndex].lastActivity = departureDateTime;
                    
                    // Update filtered data
                    const filteredIndex = filteredData.findIndex(v => v.id === visitor.id);
                    if (filteredIndex !== -1) {
                        filteredData[filteredIndex] = { ...allVisitorData[visitorIndex] };
                    }
                    
                    // Close modal
                    const modal = document.body.querySelector('div[style*="position: fixed"]');
                    if (modal) modal.remove();
                    
                    // Show success
                    showNotification(`‚úÖ ${visitor.firstName} ${visitor.surname} checked out successfully!`, 'success');
                    
                    // Refresh display
                    displayVisitorData();
                    updateStats();
                    
                    // Refresh from database
                    setTimeout(() => loadVisitorData(false), 1000);
                    
                } else {
                    const errorText = await response.text();
                    console.error(`‚ùå NEW: Update failed:`, response.status, response.statusText, errorText);
                    
                    let errorMsg = 'Update failed';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMsg = errorData.message || errorData.code || errorText;
                    } catch {
                        errorMsg = errorText;
                    }
                    
                    showNotification(`‚ùå Checkout failed: ${errorMsg}`, 'error');
                    
                    // Restore button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
                
            } catch (error) {
                console.error('‚ùå NEW: Checkout error:', error);
                showNotification(`‚ùå Error: ${error.message}`, 'error');
                
                // Restore button
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = 'üö™ Check Out';
                    submitBtn.disabled = false;
                }
            }
        }

        // ONLY CHECKOUT FUNCTION - VISITORS TABLE ONLY
        async function processCheckOut(visitor, visitorIndex) {
            console.log('üîÑ CLEAN CHECKOUT: Using visitors table only');
            
            try {
                const departureDate = document.getElementById('checkoutDate').value;
                const departureTime = document.getElementById('checkoutTime').value;
                
                if (!departureDate || !departureTime) {
                    showNotification('‚ùå Please provide both departure date and time.', 'error');
                    return;
                }
                
                // Validate that departure is not before arrival
                const arrivalDateTime = new Date(`${visitor.arrivalDate} ${visitor.arrivalTime}`);
                const departureDateTime = new Date(`${departureDate} ${departureTime}`);
                
                if (departureDateTime < arrivalDateTime) {
                    showNotification('‚ùå Departure time cannot be before arrival time.', 'error');
                    return;
                }
                
                // Show loading state
                const submitBtn = document.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '‚è≥ Checking Out...';
                submitBtn.disabled = true;
                
                console.log(`üö™ CLEAN: Checking out ${visitor.firstName} ${visitor.surname} (ID: ${visitor.id})`);
                
                // Simple update data for visitors table
                const updateData = {
                    departure_date: departureDate,
                    departure_time: departureTime,
                    status: 'departed'
                };
                
                console.log('üì§ CLEAN: Update data:', updateData);
                
                // Single API call to visitors table ONLY
                const response = await fetch(`${ADMIN_CONFIG.supabaseUrl}/rest/v1/visitors?id=eq.${visitor.id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': ADMIN_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(updateData)
                });
                
                console.log(`üì° CLEAN: Response ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    console.log('‚úÖ CLEAN: Checkout successful');
                    
                    // Update local data immediately
                    allVisitorData[visitorIndex].departureDate = departureDate;
                    allVisitorData[visitorIndex].departureTime = departureTime;
                    allVisitorData[visitorIndex].status = 'departed';
                    allVisitorData[visitorIndex].lastActivity = departureDateTime;
                    
                    // Update filtered data
                    const filteredIndex = filteredData.findIndex(v => v.id === visitor.id);
                    if (filteredIndex !== -1) {
                        filteredData[filteredIndex] = { ...allVisitorData[visitorIndex] };
                    }
                    
                    // Close modal
                    const modal = document.body.querySelector('div[style*="position: fixed"]');
                    if (modal) modal.remove();
                    
                    // Success notification
                    showNotification(`‚úÖ ${visitor.firstName} ${visitor.surname} checked out!`, 'success');
                    
                    // Refresh display
                    displayVisitorData();
                    updateStats();
                    
                    // Refresh from database
                    setTimeout(() => loadVisitorData(false), 1000);
                    
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå CLEAN: Checkout failed:', errorText);
                    
                    showNotification(`‚ùå Checkout failed: ${errorText}`, 'error');
                    
                    // Restore button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
                
            } catch (error) {
                console.error('‚ùå CLEAN: Error:', error);
                showNotification(`‚ùå Error: ${error.message}`, 'error');
                
                // Restore button
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = 'üö™ Check Out';
                    submitBtn.disabled = false;
                }
            }
        }
    </style>

<script>
if (location.hostname !== 'localhost') {
    console.log = () => {};
    console.warn = () => {};
    console.error = () => {};
    console.info = () => {};
}
</script>

</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <img src="hellohub-admin-logo.png" alt="HelloHub Admin Logo" class="login-logo">
                <p>Admin Dashboard Access</p>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label for="adminEmail">Email Address:</label>
                    <input type="email" id="adminEmail" placeholder="Enter your admin email" onkeypress="if(event.key==='Enter') doAdminLogin()">
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter your password" onkeypress="if(event.key==='Enter') doAdminLogin()">
                </div>
                <button class="login-btn" onclick="doAdminLogin()">üîê Access Dashboard</button>
                <div id="loginError" style="display: none; color: #e74c3c; text-align: center; margin-top: 15px; font-size: 14px;"></div>
            </div>
        </div>
    </div>

    <div class="dashboard-container" id="dashboardContent" style="display: none;">
        <div class="header">
            <img src="alex-davis-logo.png" alt="Alex Davis Care Group Logo" class="company-logo">
            <h1>Alex Davis Care Group</h1>
            <p>üìä HelloHub Admin Dashboard</p>
            <p style="font-size: 13px; margin-top: 5px;">Real-time visitor management and analytics</p>
            <div style="position: absolute; top: 10px; right: 15px; font-size: 10px; opacity: 0.7;">
                Configured for: Alex Davis Care Group
            </div>
            <div style="position: absolute; top: 10px; left: 15px; font-size: 12px; opacity: 0.8;">
                <span onclick="logout()" style="cursor: pointer; padding: 5px 10px; background: rgba(255,255,255,0.2); border-radius: 15px; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">üö™ Logout</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="loadVisitorData()">üîÑ Refresh Data</button>
            <button class="btn btn-warning" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            <button class="btn btn-primary" onclick="exportFeedbackPDF()">üìä Export Feedback</button>
            
            <div class="filters">
                <input type="text" class="filter-input" id="searchFilter" placeholder="Search visitors..." onkeyup="filterData()">
                <select class="filter-input" id="locationFilter" onchange="filterData()">
                    <option value="">All Locations</option>
                    <option value="The Royal">The Royal</option>
                    <option value="The Crown">The Crown</option>
                    <option value="Seabreeze">Seabreeze</option>
                </select>
                <select class="filter-input" id="statusFilter" onchange="filterData()">
                    <option value="">All Status</option>
                    <option value="arrived">Arrived</option>
                    <option value="departed">Departed</option>
                </select>
                <select class="filter-input" id="userTypeFilter" onchange="filterData()">
                    <option value="">All Types</option>
                    <option value="visitor">Visitor</option>
                    <option value="client">Client</option>
                    <option value="staff">Staff</option>
                </select>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalVisitors">-</div>
                <div class="stat-label">Total Visitors</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="currentlyInside">-</div>
                <div class="stat-label">Currently Inside</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayArrivals">-</div>
                <div class="stat-label">Today's Arrivals</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="averageVisitTime">-</div>
                <div class="stat-label">Avg Visit Time</div>
            </div>
        </div>

        <div class="data-section">
            <div class="section-title">üìã Visitor Log</div>
            <div id="dataDisplay" class="loading">
                Click "Refresh Data" to load visitor information
            </div>
        </div>

        <div class="recent-activity">
            <div class="section-title">üïí Recent Activity</div>
            <div id="recentActivity">
                <div class="activity-item">
                    <span>No recent activity</span>
                    <span class="activity-time">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const ADMIN_CONFIG = {
            supabaseUrl: 'https://obyzwhqaqyiqpeoefjgw.supabase.co',
            supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ieXp3aHFhcXlpcXBlb2Vmamd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDY0MDAsImV4cCI6MjA2NzU4MjQwMH0.NaePwt-LGqNp4vc8TTcv3IyzFkamZtiHmvDLpDcliAc'
        };

        let isLoggedIn = false;
        let allVisitorData = [];
        let filteredData = [];

        // CHECK OUT VISITOR FUNCTIONALITY - MOVED TO TOP FOR ACCESSIBILITY
        function checkOutVisitor(visitorIndex) {
            const visitor = allVisitorData[visitorIndex];
            
            if (visitor.departureTime) {
                showNotification('‚ùå This visitor has already checked out.', 'error');
                return;
            }
            
            // Go directly to checkout time selection modal (no confirmation dialog)
            showCheckOutModal(visitor, visitorIndex);
        }

        function showCheckOutModal(visitor, visitorIndex) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            const formContainer = document.createElement('div');
            formContainer.style.cssText = 'background: white; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 25px 50px rgba(0,0,0,0.3);';
            
            // Get current date and time for defaults
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            
            formContainer.innerHTML = `
                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px;">üö™ Check Out Visitor</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" 
                                style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; border-radius: 50%; opacity: 0.8; transition: opacity 0.3s;" 
                                onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">√ó</button>
                    </div>
                    <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 14px;">Set departure time for <strong>${visitor.firstName} ${visitor.surname}</strong></p>
                </div>
                
                <div style="padding: 25px;">
                    <form id="checkOutForm">
                        <div style="margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                    <div><strong>Name:</strong> ${visitor.firstName} ${visitor.surname}</div>
                                    <div><strong>Location:</strong> ${visitor.location}</div>
                                    <div><strong>Arrived:</strong> ${visitor.arrivalDate} ${visitor.arrivalTime}</div>
                                    <div><strong>User Type:</strong> ${visitor.userType}</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Departure Date *</label>
                                    <input type="date" id="checkoutDate" required value="${currentDate}" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Departure Time *</label>
                                    <input type="time" id="checkoutTime" required value="${currentTime}" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <small style="color: #666; font-size: 12px;">
                                    üí° Tip: Departure time defaults to now, but you can adjust it if needed
                                </small>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="button" onclick="this.parentElement.parentElement.parentElement.parentElement.parentElement.remove()" 
                                    style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                Cancel
                            </button>
                            <button type="submit" 
                                    style="flex: 2; padding: 12px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                üö™ Check Out
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            modal.appendChild(formContainer);
            document.body.appendChild(modal);
            
            // Focus on time field
            document.getElementById('checkoutTime').focus();
            
            // Add form styling on focus
            const inputs = formContainer.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.style.borderColor = '#e74c3c';
                    this.style.boxShadow = '0 0 0 3px rgba(231, 76, 60, 0.1)';
                });
                input.addEventListener('blur', function() {
                    this.style.borderColor = '#e0e0e0';
                    this.style.boxShadow = 'none';
                });
            });
            
            // Handle form submission
            document.getElementById('checkOutForm').addEventListener('submit', function(e) {
                e.preventDefault();
                processCheckOut(visitor, visitorIndex);
            });
        }

        async function processCheckOut(visitor, visitorIndex) {
            try {
                const departureDate = document.getElementById('checkoutDate').value;
                const departureTime = document.getElementById('checkoutTime').value;
                
                if (!departureDate || !departureTime) {
                    showNotification('‚ùå Please provide both departure date and time.', 'error');
                    return;
                }
                
                // Validate that departure is not before arrival
                const arrivalDateTime = new Date(`${visitor.arrivalDate} ${visitor.arrivalTime}`);
                const departureDateTime = new Date(`${departureDate} ${departureTime}`);
                
                if (departureDateTime < arrivalDateTime) {
                    showNotification('‚ùå Departure time cannot be before arrival time.', 'error');
                    return;
                }
                
                // Show loading state
                const submitBtn = document.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '‚è≥ Checking Out...';
                submitBtn.disabled = true;
                
                console.log(`üö™ Processing checkout for ${visitor.firstName} ${visitor.surname} (ID: ${visitor.id})`);
                
                // Prepare update data with multiple possible field names
                const updateData = {
                    departure_date: departureDate,
                    departure_time: departureTime,
                    status: 'departed',
                    // Also try alternative field names in case the table uses different conventions
                    departure_date: departureDate,
                    departure_time: departureTime
                };
                
                console.log('üì§ Sending checkout update:', updateData);
                console.log('üéØ Target visitor ID:', visitor.id);
                
                // Find which table to update and try the update
                const possibleTables = ['visitors', 'visitor_log', 'hellohub_visitors', 'visitor_data', 'visitors'];
                let success = false;
                let errorDetails = [];
                
                for (const tableName of possibleTables) {
                    try {
                        console.log(`üîÑ Attempting to update table: ${tableName}`);
                        
                        // Try to update the specific record
                        const response = await fetch(`${ADMIN_CONFIG.supabaseUrl}/rest/v1/${tableName}?id=eq.${visitor.id}`, {
                            method: 'PATCH',
                            headers: {
                                'apikey': ADMIN_CONFIG.supabaseAnonKey,
                                'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=minimal'
                            },
                            body: JSON.stringify(updateData)
                        });
                        
                        console.log(`üì° Table ${tableName} update response: ${response.status} ${response.statusText}`);
                        
                        if (response.ok) {
                            console.log(`‚úÖ Successfully updated visitor in table: ${tableName}`);
                            success = true;
                            break;
                        } else if (response.status === 404) {
                            console.log(`üìù Table ${tableName} doesn't exist or record not found`);
                                        } else {
                            const errorText = await response.text();
                            const errorDetail = `Table ${tableName}: ${response.status} ${response.statusText} - ${errorText}`;
                            errorDetails.push(errorDetail);
                            console.log(`‚ùå Update failed for table ${tableName}:`, response.status, response.statusText, errorText);
                        }
                    } catch (error) {
                        errorDetails.push(`${tableName}: ${error.message}`);
                        console.log(`‚ùå Error updating table ${tableName}:`, error.message);
                    }
                }
                
                if (success) {
                    // Update local data immediately for instant UI feedback
                    console.log('üîÑ Updating local data...');
                    allVisitorData[visitorIndex].departureDate = departureDate;
                    allVisitorData[visitorIndex].departureTime = departureTime;
                    allVisitorData[visitorIndex].status = 'departed';
                    allVisitorData[visitorIndex].lastActivity = departureDateTime;
                    
                    // Update filtered data if this visitor is currently shown
                    const filteredIndex = filteredData.findIndex(v => v.id === visitor.id);
                    if (filteredIndex !== -1) {
                        filteredData[filteredIndex] = { ...allVisitorData[visitorIndex] };
                    }
                    
                    // Close modal
                    const modal = document.body.querySelector('div[style*="position: fixed"]');
                    if (modal) modal.remove();
                    
                    // Show success message
                    showNotification(`‚úÖ ${visitor.firstName} ${visitor.surname} has been checked out successfully!`, 'success');
                    
                    // Refresh display immediately
                    displayVisitorData();
                    updateStats();
                    
                    // Also refresh from database after a short delay to ensure sync
                    setTimeout(() => {
                        console.log('üîÑ Refreshing from database to confirm update...');
                        loadVisitorData(false);
                    }, 2000);
                    
                } else {
                    console.error('‚ùå Failed to update visitor in any table:', errorDetails);
                    showNotification(`‚ùå Failed to check out visitor. Details: ${errorDetails.join('; ')}`, 'error');
                    
                    // Restore button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
                
            } catch (error) {
                console.error('‚ùå Error processing checkout:', error);
                showNotification('‚ùå An error occurred while checking out the visitor.', 'error');
                
                // Restore button
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = 'üö™ Check Out';
                    submitBtn.disabled = false;
                }
            }
        }

        // Login function
        function doAdminLogin() {
            const email = document.getElementById('adminEmail').value.trim().toLowerCase();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (!email || !password) {
                showLoginError('Please enter both email and password.');
                return;
            }
            
            if (email === 'office@alexdavis.co.uk' && password === 'office927') {
                document.getElementById('adminEmail').value = '';
                document.getElementById('adminPassword').value = '';
                hideLoginError();
                
                isLoggedIn = true;
                localStorage.setItem('hellohubAdminSession', JSON.stringify({
                    isLoggedIn: true,
                    loginTime: Date.now()
                }));
                
                showDashboard();
            } else {
                showLoginError('Invalid email or password.');
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideLoginError() {
            document.getElementById('loginError').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
            loadVisitorData();
        }

        function logout() {
            localStorage.removeItem('hellohubAdminSession');
            isLoggedIn = false;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardContent').style.display = 'none';
        }

        // Main data loading function - SILENT VERSION
        async function loadVisitorData(showMessage = true) {
            console.log('üîÑ Loading visitor data...');
            
            // Only show loading message for manual refresh
            if (showMessage) {
                document.getElementById('dataDisplay').innerHTML = '<div class="loading">üîÑ Loading visitor data...</div>';
            }
            
            const refreshBtn = document.querySelector('button[onclick="loadVisitorData()"]');
            const originalText = refreshBtn.innerHTML;
            
            // Only show button loading state for manual refresh
            if (showMessage) {
                refreshBtn.innerHTML = '‚è≥ Loading...';
                refreshBtn.disabled = true;
            }
            
            try {
                // Try different possible table names
                const possibleQueries = [
                    'visitors?select=*&order=created_at.desc',
                    'visitor_log?select=*&order=created_at.desc', 
                    'hellohub_visitors?select=*&order=created_at.desc',
                    'visitor_data?select=*&order=created_at.desc',
                    'visitors?select=*&order=created_at.desc'
                ];

                let data = null;
                let successfulQuery = null;

                for (const query of possibleQueries) {
                    try {
                        const response = await fetch(`${ADMIN_CONFIG.supabaseUrl}/rest/v1/${query}`, {
                            method: 'GET',
                            headers: {
                                'apikey': ADMIN_CONFIG.supabaseAnonKey,
                                'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            data = await response.json();
                            successfulQuery = query;
                            console.log(`‚úÖ Success with query: ${query}, found ${data.length} records`);
                            break;
                        }
                    } catch (error) {
                        console.log(`‚ùå Error with query: ${query} - ${error.message}`);
                    }
                }

                if (!data) {
                    throw new Error('No data found in any expected table');
                }

                console.log('üìä Raw data received:', data.length, 'total records');

                // Convert and merge records for same person on same day
                const rawVisitors = data.map(row => {
                    const visitor = {
                        id: row.id,
                        timestamp: new Date(row.created_at || Date.now()),
                        firstName: row.first_name || row.firstName || row.visitor_name?.split(' ')[0] || 'Unknown',
                        surname: row.surname || row.lastName || row.visitor_name?.split(' ').slice(1).join(' ') || '',
                        email: row.email || row.visitor_email || 'Not provided',
                        mobile: row.mobile || row.phone || row.visitor_phone || 'Not provided',
                        userType: row.user_type || row.type || row.visitor_type || 'visitor',
                        location: row.location || row.site || row.facility || 'Unknown',
                        arrivalDate: row.arrival_date || '',
                        arrivalTime: row.arrival_time || '',
                        departureDate: row.departure_date || '',
                        departureTime: row.departure_time || '',
                        status: row.status || (row.departure_time ? 'departed' : 'arrived'),
                        feedback: null
                    };

                    // Add feedback if it exists
                    if (row.feedback_overall && row.feedback_overall > 0) {
                        visitor.feedback = {
                            overall: row.feedback_overall,
                            safety: row.feedback_safety || 0,
                            responsive: row.feedback_responsive || 0,
                            caring: row.feedback_caring || 0,
                            leadership: row.feedback_leadership || 0,
                            effectiveness: row.feedback_effectiveness || 0,
                            averageRating: row.feedback_average || 0,
                            additionalComments: row.feedback_comments || 'No additional comments'
                        };
                    }

                    return visitor;
                });

                // Merge arrival and departure records for same person
                allVisitorData = mergeVisitorRecords(rawVisitors);

                console.log('‚úÖ Final merged data:', allVisitorData.length, 'unique visitor records');

                // Initialize filtered data and display
                filteredData = [...allVisitorData];
                displayVisitorData();
                updateStats();
                
                // Only show success message for manual refresh
                if (showMessage) {
                    showNotification(`‚úÖ Loaded ${allVisitorData.length} visitor records`, 'success');
                }

            } catch (error) {
                console.error('‚ùå Error loading from Supabase:', error);
                
                // Fallback to localStorage
                const localData = JSON.parse(localStorage.getItem('hellohubVisitors') || '[]');
                
                allVisitorData = mergeVisitorRecords(localData.map(visitor => ({
                    ...visitor,
                    timestamp: new Date(visitor.timestamp)
                })));
                
                // Initialize filtered data and display
                filteredData = [...allVisitorData];
                displayVisitorData();
                updateStats();
                
                // Only show error message for manual refresh
                if (showMessage) {
                    showNotification(`‚ö†Ô∏è Using local data (${allVisitorData.length} records) - Database connection failed`, 'error');
                }
            } finally {
                // Only reset button state for manual refresh
                if (showMessage) {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }
            }
        }

        // Enhanced function to merge arrival and departure records - SAME DAY ONLY
        function mergeVisitorRecords(rawRecords) {
            console.log('üîÑ Starting enhanced merge process with', rawRecords.length, 'raw records');
            
            const mergedRecords = [];
            const recordMap = new Map();

            // Sort by timestamp to process in chronological order
            rawRecords.sort((a, b) => a.timestamp - b.timestamp);

            rawRecords.forEach((record, index) => {
                // Determine the actual visit date from the record
                let visitDate = null;
                
                // Priority order: arrival_date > departure_date > created_at date
                if (record.arrivalDate && record.arrivalDate.trim()) {
                    visitDate = record.arrivalDate.trim();
                } else if (record.departureDate && record.departureDate.trim()) {
                    visitDate = record.departureDate.trim();
                } else {
                    // Use the date part of the timestamp as fallback
                    visitDate = new Date(record.timestamp).toLocaleDateString('en-CA'); // YYYY-MM-DD format
                }
                
                // Normalize the date format to YYYY-MM-DD for consistent comparison
                try {
                    const dateObj = new Date(visitDate);
                    if (!isNaN(dateObj)) {
                        visitDate = dateObj.toLocaleDateString('en-CA'); // YYYY-MM-DD
                    }
                } catch (error) {
                    visitDate = new Date(record.timestamp).toLocaleDateString('en-CA');
                }
                
                // Create unique key: person + location + EXACT DATE
                const personKey = `${record.firstName.toLowerCase().trim()}_${record.surname.toLowerCase().trim()}`;
                const locationKey = record.location.toLowerCase().trim();
                const uniqueKey = `${personKey}_${locationKey}_${visitDate}`;
                
                console.log(`Processing record ${index + 1}:`, {
                    name: `${record.firstName} ${record.surname}`,
                    location: record.location,
                    visitDate: visitDate,
                    arrivalTime: record.arrivalTime,
                    departureTime: record.departureTime,
                    status: record.status,
                    key: uniqueKey
                });
                
                if (recordMap.has(uniqueKey)) {
                    // MERGE: Found existing record for same person, location, and date
                    const existing = recordMap.get(uniqueKey);
                    console.log(`  ‚Üí Merging with existing record for ${existing.firstName} ${existing.surname} on ${visitDate}`);
                    
                    // Case 1: This record has departure info, existing has arrival
                    if (record.departureTime && record.departureTime.trim() && !existing.departureTime) {
                        existing.departureDate = record.departureDate || visitDate;
                        existing.departureTime = record.departureTime.trim();
                        existing.status = 'departed';
                        console.log(`  ‚Üí Added departure: ${record.departureTime} to existing arrival record`);
                        
                        // Add feedback if this departure record has it
                        if (record.feedback) {
                            existing.feedback = record.feedback;
                            console.log(`  ‚Üí Added feedback from departure record`);
                        }
                        
                        // Update last activity to departure time
                        try {
                            existing.lastActivity = new Date(`${existing.departureDate} ${existing.departureTime}`);
                        } catch {
                            existing.lastActivity = record.timestamp;
                        }
                    }
                    
                    // Case 2: This record has arrival info, existing has departure (less common)
                    else if (record.arrivalTime && record.arrivalTime.trim() && !existing.arrivalTime) {
                        existing.arrivalDate = record.arrivalDate || visitDate;
                        existing.arrivalTime = record.arrivalTime.trim();
                        console.log(`  ‚Üí Added arrival: ${record.arrivalTime} to existing departure record`);
                        
                        // Update contact info from arrival record (usually more complete)
                        if (record.email && record.email !== 'Not provided' && 
                            (!existing.email || existing.email === 'Not provided')) {
                            existing.email = record.email;
                            console.log(`  ‚Üí Updated email from arrival record`);
                        }
                        if (record.mobile && record.mobile !== 'Not provided' && 
                            (!existing.mobile || existing.mobile === 'Not provided')) {
                            existing.mobile = record.mobile;
                            console.log(`  ‚Üí Updated mobile from arrival record`);
                        }
                        
                        // Keep departure status if we already have departure time
                        existing.status = existing.departureTime ? 'departed' : 'arrived';
                    }
                    
                    // Case 3: Both records have same type of time (potential duplicate)
                    else if ((record.arrivalTime && existing.arrivalTime) || 
                             (record.departureTime && existing.departureTime)) {
                        console.log(`  ‚ö†Ô∏è Warning: Duplicate ${record.arrivalTime ? 'arrival' : 'departure'} record for same person/day - keeping existing`);
                        
                        // Still update contact info if this record has better data
                        if (record.email && record.email !== 'Not provided' && 
                            (!existing.email || existing.email === 'Not provided')) {
                            existing.email = record.email;
                        }
                        if (record.mobile && record.mobile !== 'Not provided' && 
                            (!existing.mobile || existing.mobile === 'Not provided')) {
                            existing.mobile = record.mobile;
                        }
                    }
                    
                } else {
                    // NEW RECORD: Create new entry for this person/location/date combination
                    const mergedRecord = {
                        ...record,
                        lastActivity: record.timestamp,
                        visitDate: visitDate // Store the normalized visit date
                    };
                    
                    // Ensure we have proper visit dates
                    if (!mergedRecord.arrivalDate && mergedRecord.arrivalTime) {
                        mergedRecord.arrivalDate = visitDate;
                    }
                    if (!mergedRecord.departureDate && mergedRecord.departureTime) {
                        mergedRecord.departureDate = visitDate;
                    }
                    
                    // If this record has both arrival and departure times (complete visit)
                    if (record.arrivalTime && record.departureTime) {
                        try {
                            mergedRecord.lastActivity = new Date(`${mergedRecord.departureDate || visitDate} ${record.departureTime}`);
                        } catch {
                            mergedRecord.lastActivity = record.timestamp;
                        }
                        console.log(`  ‚Üí Complete visit record: ${record.arrivalTime} - ${record.departureTime} on ${visitDate}`);
                    } else if (record.arrivalTime) {
                        console.log(`  ‚Üí New arrival record: ${record.arrivalTime} on ${visitDate}`);
                    } else if (record.departureTime) {
                        console.log(`  ‚Üí New departure record: ${record.departureTime} on ${visitDate}`);
                    }
                    
                    recordMap.set(uniqueKey, mergedRecord);
                }
            });

            // Convert map back to array and sort by last activity (most recent first)
            const finalRecords = Array.from(recordMap.values()).sort((a, b) => b.lastActivity - a.lastActivity);
            
            console.log('‚úÖ Enhanced merge complete:', {
                inputRecords: rawRecords.length,
                outputRecords: finalRecords.length,
                mergedCount: rawRecords.length - finalRecords.length,
                note: 'Each person can have multiple visits on different dates, but arrival/departure are matched by exact date'
            });
            
            // Log sample of final records for verification
            console.log('üìä Sample merged records:', finalRecords.slice(0, 3).map(r => ({
                name: `${r.firstName} ${r.surname}`,
                visitDate: r.visitDate || r.arrivalDate || r.departureDate,
                arrival: r.arrivalTime,
                departure: r.departureTime,
                status: r.status,
                location: r.location
            })));
            
            return finalRecords;
        }

        function displayVisitorData() {
// Sort by arrivalDate and arrivalTime (newest first)
    filteredData.sort((a, b) => {
        const aDate = new Date(`${a.arrivalDate || ''} ${a.arrivalTime || ''}`);
        const bDate = new Date(`${b.arrivalDate || ''} ${b.arrivalTime || ''}`);
        return bDate - aDate;
    });

    
    // Sort visitors by arrival_date and arrival_time (newest first)
    filteredData.sort((a, b) => {
        const aDate = new Date(`${a.arrivalDate || ''} ${a.arrivalTime || ''}`);
        const bDate = new Date(`${b.arrivalDate || ''} ${b.arrivalTime || ''}`);
        return bDate - aDate;
    });
    // Sort by arrival date and time
    filteredData.sort((a, b) => {
        const aDate = new Date(`${a.arrivalDate} ${a.arrivalTime}`);
        const bDate = new Date(`${b.arrivalDate} ${b.arrivalTime}`);
        return bDate - aDate;
    });

            // Don't reset filteredData here - use the already filtered data
            
            if (filteredData.length === 0) {
                if (allVisitorData.length === 0) {
                    document.getElementById('dataDisplay').innerHTML = 
                        '<div class="loading">No visitor data found. Use HelloHub check-in system to add records.</div>';
                } else {
                    document.getElementById('dataDisplay').innerHTML = 
                        '<div class="loading">No records match the current filters. Try adjusting your search criteria.</div>';
                }
                return;
            }

            let tableHTML = `
                <table class="visitor-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Contact</th>
                            <th>Arrived</th>
                            <th>Departed</th>
                            <th>Duration</th>
                            <th>Status</th>
                            <th>Feedback</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredData.forEach(visitor => {
                // Determine status and styling
                let statusClass, statusText, statusIcon;
                if (visitor.departureTime) {
                    statusClass = 'status-departed';
                    statusText = 'LEFT';
                    statusIcon = '‚úÖ';
                } else {
                    statusClass = 'status-arrived';
                    statusText = 'INSIDE';
                    statusIcon = 'üîÑ';
                }
                
                // Calculate visit duration
                let duration = '-';
                if (visitor.arrivalTime && visitor.departureTime && visitor.arrivalDate && visitor.departureDate) {
                    try {
                        const arrivalDateTime = new Date(`${visitor.arrivalDate} ${visitor.arrivalTime}`);
                        const departureDateTime = new Date(`${visitor.departureDate} ${visitor.departureTime}`);
                        const durationMs = departureDateTime - arrivalDateTime;
                        
                        if (durationMs > 0) {
                            const hours = Math.floor(durationMs / (1000 * 60 * 60));
                            const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                            duration = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                        }
                    } catch (error) {
                        duration = '-';
                    }
                }
                
                // Handle feedback display
                let feedbackHTML = '-';
                if (visitor.feedback && visitor.userType === 'visitor') {
                    const avg = calculateAverageRating(visitor.feedback);
                    feedbackHTML = `
                        <div style="text-align: center;">
                            <div style="color: #f39c12; font-weight: bold;">
                                ${generateStars(avg)} <small>(${avg.toFixed(1)})</small>
                            </div>
                            <button class="btn" style="padding: 3px 8px; font-size: 10px; background: #17a2b8; color: white; margin-top: 4px;" 
                                    onclick="showFeedbackDetails(${allVisitorData.indexOf(visitor)})">View Details</button>
                        </div>
                    `;
                } else if (visitor.userType === 'visitor' && visitor.departureTime) {
                    feedbackHTML = '<small style="color: #999;">No feedback provided</small>';
                } else if (visitor.userType === 'visitor') {
                    feedbackHTML = '<small style="color: #666;">Pending departure</small>';
                }
                
                // Format display date
                const displayDate = visitor.arrivalDate || visitor.lastActivity.toLocaleDateString();
                
                tableHTML += `
                    <tr>
                        <td><strong>${displayDate}</strong><br><small>${visitor.lastActivity.toLocaleTimeString()}</small></td>
                        <td><strong>${visitor.firstName} ${visitor.surname}</strong></td>
                        <td><span style="background: ${visitor.userType === 'visitor' ? '#e3f2fd' : visitor.userType === 'staff' ? '#f3e5f5' : visitor.userType === 'client' ? '#e8f5e8' : '#fff3e0'}; color: ${visitor.userType === 'visitor' ? '#1565c0' : visitor.userType === 'staff' ? '#7b1fa2' : visitor.userType === 'client' ? '#2e7d32' : '#ef6c00'}; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">${visitor.userType.toUpperCase()}</span></td>
                        <td>${visitor.location}</td>
                        <td>
                            <div style="font-size: 12px;">
                                <div>${visitor.email}</div>
                                <div style="color: #666; margin-top: 2px;">${visitor.mobile}</div>
                            </div>
                        </td>
                        <td><strong style="color: #27ae60;">${visitor.arrivalTime || '-'}</strong></td>
                        <td><strong style="color: #e74c3c;">${visitor.departureTime || '-'}</strong></td>
                        <td><strong style="color: #3498db;">${duration}</strong></td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${statusIcon} ${statusText}
                            </span>
                            ${!visitor.departureTime ? `
                                <br><button class="btn" style="padding: 3px 8px; font-size: 10px; background: #e74c3c; color: white; margin-top: 4px;" 
                                        onclick="checkOutVisitor(${allVisitorData.indexOf(visitor)})">Check Out</button>
                            ` : ''}
                        </td>
                        <td>${feedbackHTML}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            document.getElementById('dataDisplay').innerHTML = tableHTML;
        }

        function updateStats() {
            const total = allVisitorData.length;
            const currentlyInside = allVisitorData.filter(v => !v.departureTime).length;
            const today = new Date().toLocaleDateString();
            const todayArrivals = allVisitorData.filter(v => v.arrivalDate === today).length;

            document.getElementById('totalVisitors').textContent = total;
            document.getElementById('currentlyInside').textContent = currentlyInside;
            document.getElementById('todayArrivals').textContent = todayArrivals;
            
            // Calculate average visit time for completed visits
            const completedVisits = allVisitorData.filter(v => 
                v.arrivalTime && 
                v.departureTime && 
                v.arrivalDate && 
                v.departureDate
            );
            
            if (completedVisits.length > 0) {
                const totalDuration = completedVisits.reduce((sum, visitor) => {
                    try {
                        const arrival = new Date(`${visitor.arrivalDate} ${visitor.arrivalTime}`);
                        const departure = new Date(`${visitor.departureDate} ${visitor.departureTime}`);
                        const duration = (departure - arrival) / (1000 * 60); // minutes
                        return sum + (duration > 0 ? duration : 0);
                    } catch {
                        return sum;
                    }
                }, 0);
                
                const avgMinutes = totalDuration / completedVisits.length;
                const hours = Math.floor(avgMinutes / 60);
                const minutes = Math.round(avgMinutes % 60);
                document.getElementById('averageVisitTime').textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
            } else {
                document.getElementById('averageVisitTime').textContent = '-';
            }
            
            updateRecentActivity();
        }

        function updateRecentActivity() {
            const recent = allVisitorData
                .sort((a, b) => b.lastActivity - a.lastActivity)
                .slice(0, 5);

            let activityHTML = '';
            recent.forEach(visitor => {
                let action, actionTime;
                if (visitor.departureTime) {
                    action = 'checked out';
                    actionTime = visitor.departureTime;
                } else {
                    action = 'checked in';
                    actionTime = visitor.arrivalTime || visitor.lastActivity.toLocaleTimeString();
                }
                
                activityHTML += `
                    <div class="activity-item">
                        <span><strong>${visitor.firstName} ${visitor.surname}</strong> ${action} at ${visitor.location}</span>
                        <span class="activity-time">${actionTime}</span>
                    </div>
                `;
            });

            if (activityHTML === '') {
                activityHTML = '<div class="activity-item"><span>No recent activity</span><span class="activity-time">-</span></div>';
            }

            document.getElementById('recentActivity').innerHTML = activityHTML;
        }

        function filterData() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const userTypeFilter = document.getElementById('userTypeFilter').value;

            filteredData = allVisitorData.filter(visitor => {
                const matchesSearch = searchTerm === '' || 
                    visitor.firstName.toLowerCase().includes(searchTerm) ||
                    visitor.surname.toLowerCase().includes(searchTerm) ||
                    visitor.email.toLowerCase().includes(searchTerm);

                const matchesLocation = locationFilter === '' || visitor.location === locationFilter;
                const matchesStatus = statusFilter === '' || visitor.status === statusFilter;
                const matchesUserType = userTypeFilter === '' || visitor.userType.toLowerCase() === userTypeFilter.toLowerCase();

                return matchesSearch && matchesLocation && matchesStatus && matchesUserType;
            });

            displayVisitorData();
        }

        function showFeedbackDetails(visitorIndex) {
            const visitor = allVisitorData[visitorIndex];
            if (!visitor.feedback) return;
            
            const feedback = visitor.feedback;
            const avgRating = calculateAverageRating(feedback);
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;';
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #333; margin: 0;">üìã Visitor Feedback Details</h3>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 5px; border-radius: 50%;">√ó</button>
                </div>
                
                <div style="text-align: center; margin-bottom: 25px;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">${visitor.firstName} ${visitor.surname}</h4>
                    <div style="font-size: 24px; color: #f39c12; margin-bottom: 5px;">
                        ${generateStars(avgRating)}
                    </div>
                    <div style="color: #7f8c8d; font-size: 14px;">
                        Average Rating: ${avgRating.toFixed(1)} / 5.0
                    </div>
                </div>
                
                <div style="display: grid; gap: 15px;">
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Overall Experience:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.overall)} (${feedback.overall}/5)</span>
                    </div>
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Keeps People Safe:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.safety)} (${feedback.safety}/5)</span>
                    </div>
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Responsive to Needs:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.responsive)} (${feedback.responsive}/5)</span>
                    </div>
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Caring Towards People:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.caring)} (${feedback.caring}/5)</span>
                    </div>
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Well-Led:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.leadership)} (${feedback.leadership}/5)</span>
                    </div>
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Effective Care:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.effectiveness)} (${feedback.effectiveness}/5)</span>
                    </div>
                    ${feedback.additionalComments && feedback.additionalComments !== 'No additional comments' ? `
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                        <span style="font-weight: bold; color: #2c3e50;">Additional Comments:</span>
                        <p style="margin-top: 8px; color: #555; font-style: italic;">"${feedback.additionalComments}"</p>
                    </div>
                    ` : ''}
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Close</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function calculateAverageRating(feedback) {
            if (!feedback) return 0;
            const ratings = [
                feedback.overall,
                feedback.safety,
                feedback.responsive,
                feedback.caring,
                feedback.leadership,
                feedback.effectiveness
            ].filter(rating => rating > 0);
            
            if (ratings.length === 0) return 0;
            return ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length;
        }

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let stars = '';
            
            for (let i = 0; i < fullStars; i++) {
                stars += '‚≠ê';
            }
            if (hasHalfStar) {
                stars += '‚ú®';
            }
            
            return stars || '‚òÜ';
        }

        function showNotification(text, type = 'info') {
            const existingMsg = document.querySelector('.temp-message');
            if (existingMsg) existingMsg.remove();
            
            const message = document.createElement('div');
            message.className = 'temp-message';
            message.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1001;
                padding: 15px 20px; border-radius: 8px; font-weight: bold;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                transform: translateX(400px); transition: all 0.3s ease;
                ${type === 'success' ? 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;' : ''}
                ${type === 'info' ? 'background: #e3f2fd; color: #0277bd; border: 1px solid #b3e5fc;' : ''}
                ${type === 'error' ? 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;' : ''}
            `;
            message.textContent = text;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                message.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 300);
            }, 3000);
        }

        // Add visitor form functionality
        function showAddVisitorForm() {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            const formContainer = document.createElement('div');
            formContainer.style.cssText = 'background: white; border-radius: 15px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3);';
            
            formContainer.innerHTML = `
                <div style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px;">‚ûï Add New Visitor</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" 
                                style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; border-radius: 50%; opacity: 0.8; transition: opacity 0.3s;" 
                                onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">√ó</button>
                    </div>
                    <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 14px;">Manually add a visitor record to the system</p>
                </div>
                
                <div style="padding: 25px;">
                    <form id="addVisitorForm">
                        <div style="display: grid; gap: 20px;">
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">First Name *</label>
                                    <input type="text" id="newFirstName" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Surname *</label>
                                    <input type="text" id="newSurname" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;">
                                </div>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Email Address</label>
                                <input type="email" id="newEmail" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;" placeholder="visitor@example.com">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Mobile Number</label>
                                <input type="tel" id="newMobile" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;" placeholder="07123 456789">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">User Type *</label>
                                    <select id="newUserType" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
                                        <option value="">Select Type</option>
                                        <option value="visitor">Visitor</option>
                                        <option value="client">Client</option>
                                        <option value="staff">Staff</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Location *</label>
                                    <select id="newLocation" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
                                        <option value="">Select Location</option>
                                        <option value="The Royal">The Royal</option>
                                        <option value="The Crown">The Crown</option>
                                        <option value="Seabreeze">Seabreeze</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Arrival Date *</label>
                                    <input type="date" id="newArrivalDate" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Arrival Time *</label>
                                    <input type="time" id="newArrivalTime" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Departure Date</label>
                                    <input type="date" id="newDepartureDate" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <small style="color: #666; font-size: 12px;">Leave empty if still inside</small>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Departure Time</label>
                                    <input type="time" id="newDepartureTime" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <small style="color: #666; font-size: 12px;">Leave empty if still inside</small>
                                </div>
                            </div>
                            
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                            <button type="button" onclick="this.parentElement.parentElement.parentElement.parentElement.parentElement.remove()" 
                                    style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                Cancel
                            </button>
                            <button type="submit" 
                                    style="flex: 2; padding: 12px; background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                ‚ûï Add Visitor
                            </button>
                        </div>
                        
                    </form>
                </div>
            `;
            
            modal.appendChild(formContainer);
            document.body.appendChild(modal);
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newArrivalDate').value = today;
            
            // Set default time to current time
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            document.getElementById('newArrivalTime').value = currentTime;
            
            // Focus on first name field
            document.getElementById('newFirstName').focus();
            
            // Add form styling on focus
            const inputs = formContainer.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.style.borderColor = '#3498db';
                    this.style.boxShadow = '0 0 0 3px rgba(52, 152, 219, 0.1)';
                });
                input.addEventListener('blur', function() {
                    this.style.borderColor = '#e0e0e0';
                    this.style.boxShadow = 'none';
                });
            });
            
            // Handle form submission
            document.getElementById('addVisitorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitNewVisitor();
            });
        }

        async function submitNewVisitor() {
            try {
                // Get form data
                const formData = {
                    firstName: document.getElementById('newFirstName').value.trim(),
                    surname: document.getElementById('newSurname').value.trim(),
                    email: document.getElementById('newEmail').value.trim() || 'Not provided',
                    mobile: document.getElementById('newMobile').value.trim() || 'Not provided',
                    userType: document.getElementById('newUserType').value,
                    location: document.getElementById('newLocation').value,
                    arrivalDate: document.getElementById('newArrivalDate').value,
                    arrivalTime: document.getElementById('newArrivalTime').value,
                    departureDate: document.getElementById('newDepartureDate').value || null,
                    departureTime: document.getElementById('newDepartureTime').value || null
                };

                console.log('üìù Form data collected:', formData);

                // Validate required fields
                if (!formData.firstName || !formData.surname || !formData.userType || !formData.location || !formData.arrivalDate || !formData.arrivalTime) {
                    showNotification('‚ùå Please fill in all required fields marked with *', 'error');
                    return;
                }

                // Validate departure logic
                if (formData.departureDate && !formData.departureTime) {
                    showNotification('‚ùå If departure date is set, departure time is also required', 'error');
                    return;
                }
                if (formData.departureTime && !formData.departureDate) {
                    formData.departureDate = formData.arrivalDate; // Same day departure
                }

                console.log('‚úÖ Form validation passed');

                // Show loading state
                const submitBtn = document.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '‚è≥ Adding Visitor...';
                submitBtn.disabled = true;

                // Prepare data for Supabase
                const supabaseData = {
                    first_name: formData.firstName,
                    surname: formData.surname,
                    email: formData.email,
                    mobile: formData.mobile,
                    user_type: formData.userType,
                    location: formData.location,
                    arrival_date: formData.arrivalDate,
                    arrival_time: formData.arrivalTime,
                    departure_date: formData.departureDate,
                    departure_time: formData.departureTime,
                    status: formData.departureTime ? 'departed' : 'arrived',
                    created_at: new Date().toISOString()
                };

                console.log('üì§ Prepared Supabase data:', supabaseData);
                console.log('üîó Using Supabase URL:', ADMIN_CONFIG.supabaseUrl);

                // First, let's determine which table to use by checking what table has existing data
                console.log('üîç Detecting active table...');
                const possibleTables = ['visitors', 'visitor_log', 'hellohub_visitors', 'visitor_data', 'visitors'];
                let targetTable = null;

                // Find the table that currently has data (same logic as data loading)
                for (const tableName of possibleTables) {
                    try {
                        const checkResponse = await fetch(`${ADMIN_CONFIG.supabaseUrl}/rest/v1/${tableName}?select=id&limit=1`, {
                            method: 'GET',
                            headers: {
                                'apikey': ADMIN_CONFIG.supabaseAnonKey,
                                'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`
                            }
                        });

                        console.log(`üìä Table ${tableName} check: ${checkResponse.status}`);

                        if (checkResponse.ok) {
                            const data = await checkResponse.json();
                            if (data.length > 0 || checkResponse.status === 200) {
                                targetTable = tableName;
                                console.log(`‚úÖ Found target table: ${tableName}`);
                                break;
                            }
                        }
                    } catch (error) {
                        console.log(`‚ùå Error checking table ${tableName}:`, error.message);
                    }
                }

                // If no table found with data, default to 'visitors'
                if (!targetTable) {
                    targetTable = 'visitors';
                    console.log('üìù No active table found, defaulting to: visitors');
                }

                // Try to submit to the target table
                console.log(`üì§ Attempting to submit to table: ${targetTable}`);
                
                try {
                    const response = await fetch(`${ADMIN_CONFIG.supabaseUrl}/rest/v1/${targetTable}`, {
                        method: 'POST',
                        headers: {
                            'apikey': ADMIN_CONFIG.supabaseAnonKey,
                            'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(supabaseData)
                    });

                    console.log(`üì° Response status: ${response.status} ${response.statusText}`);

                    if (response.ok) {
                        console.log(`‚úÖ Successfully added visitor to table: ${targetTable}`);
                        
                        // Close modal
                        const modal = document.body.querySelector('div[style*="position: fixed"]');
                        if (modal) modal.remove();
                        
                        // Show success message
                        showNotification(`‚úÖ ${formData.firstName} ${formData.surname} has been added successfully!`, 'success');
                        
                        // Refresh data to show new visitor
                        setTimeout(() => {
                            loadVisitorData(false);
                        }, 1000);
                        
                        return;
                    } else {
                        const errorText = await response.text();
                        console.error(`‚ùå Supabase error: ${response.status} - ${errorText}`);
                        
                        // Try to parse error for more details
                        try {
                            const errorData = JSON.parse(errorText);
                            console.error('üìã Detailed error:', errorData);
                            showNotification(`‚ùå Database error: ${errorData.message || errorData.hint || 'Unknown error'}`, 'error');
                        } catch {
                            showNotification(`‚ùå Database error: ${response.status} - ${errorText}`, 'error');
                        }
                    }
                } catch (fetchError) {
                    console.error('‚ùå Network error:', fetchError);
                    showNotification(`‚ùå Network error: ${fetchError.message}`, 'error');
                }

                // If we get here, submission failed - restore button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;

            } catch (error) {
                console.error('‚ùå Unexpected error adding visitor:', error);
                showNotification('‚ùå An unexpected error occurred while adding the visitor.', 'error');
                
                // Restore button
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '‚ûï Add Visitor';
                    submitBtn.disabled = false;
                }
            }
        }

        // Add a test function to check database connectivity
        async function testDatabaseWrite() {
            console.log('üß™ Testing database write capability...');
            
            const testData = {
                first_name: 'Test',
                surname: 'User',
                email: 'test@example.com',
                mobile: 'Test',
                user_type: 'visitor',
                location: 'The Royal',
                arrival_date: new Date().toISOString().split('T')[0],
                arrival_time: '12:00',
                status: 'arrived',
                created_at: new Date().toISOString()
            };

            try {
                const response = await fetch(`${ADMIN_CONFIG.supabaseUrl}/rest/v1/visitors`, {
                    method: 'POST',
                    headers: {
                        'apikey': ADMIN_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(testData)
                });

                console.log(`üß™ Test write result: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('üß™ Test write failed:', errorText);
                }
                
                return response.ok;
            } catch (error) {
                console.error('üß™ Test write error:', error);
                return false;
            }
        }

        function clearAllData() {
            // Enhanced confirmation dialog
            const confirmMessage = `‚ö†Ô∏è WARNING: Clear All Data
            
This will permanently delete ALL visitor data including:
‚Ä¢ All visitor records and check-ins
‚Ä¢ All feedback submissions  
‚Ä¢ All historical data
‚Ä¢ All statistics

This action CANNOT be undone!

Are you absolutely sure you want to proceed?`;

            if (confirm(confirmMessage)) {
                // Second confirmation for extra safety
                const finalConfirm = confirm('üö® FINAL WARNING: This will delete EVERYTHING. Click OK to confirm deletion or Cancel to abort.');
                
                if (finalConfirm) {
                    try {
                        // Show clearing message immediately
                        document.getElementById('dataDisplay').innerHTML = '<div class="loading">üóëÔ∏è Clearing all data...</div>';
                        
                        // Stop auto-refresh temporarily to prevent immediate reload
                        clearInterval(window.autoRefreshInterval);
                        
                        // Clear Supabase data first
                        clearSupabaseData().then((result) => {
                            // Clear from local storage
                            localStorage.removeItem('hellohubVisitors');
                            
                            // Clear from memory
                            allVisitorData = [];
                            filteredData = [];
                            
                            // Update display immediately
                            displayVisitorData();
                            updateStats();
                            
                            // Show detailed success notification
                            if (result.clearedTables.length > 0) {
                                showNotification(`üóëÔ∏è Successfully cleared ${result.clearedTables.length} table(s): ${result.clearedTables.join(', ')}`, 'success');
                            } else {
                                showNotification('‚ö†Ô∏è Database clearing may have failed. Local data cleared.', 'error');
                            }
                            
                            console.log('‚úÖ All data cleared successfully from all sources');
                            
                            // Restart auto-refresh after 5 seconds to give time to see the cleared state
                            setTimeout(() => {
                                window.autoRefreshInterval = setInterval(() => {
                                    if (isLoggedIn) {
                                        loadVisitorData(false);
                                    }
                                }, 30000);
                            }, 5000);
                            
                        }).catch(error => {
                            console.error('‚ùå Error clearing Supabase data:', error);
                            
                            // Force clear local data even if Supabase fails
                            localStorage.removeItem('hellohubVisitors');
                            allVisitorData = [];
                            filteredData = [];
                            displayVisitorData();
                            updateStats();
                            
                            // Show detailed error with troubleshooting
                            showNotification(`‚ùå Database clear failed: ${error.message}. Check console for details.`, 'error');
                            
                            // Restart auto-refresh
                            setTimeout(() => {
                                window.autoRefreshInterval = setInterval(() => {
                                    if (isLoggedIn) {
                                        loadVisitorData(false);
                                    }
                                }, 30000);
                            }, 5000);
                        });
                        
                    } catch (error) {
                        console.error('‚ùå Error clearing data:', error);
                        showNotification('‚ùå Error occurred while clearing data. Please try again.', 'error');
                    }
                } else {
                    showNotification('‚úÖ Data deletion cancelled.', 'info');
                }
            } else {
                showNotification('‚úÖ Data deletion cancelled.', 'info');
            }
        }

        // Enhanced function to clear Supabase data with better debugging
        async function clearSupabaseData() {
            console.log('üóëÔ∏è Starting Supabase data clearing process...');
            
            // First, let's find which table actually has data
            const possibleTables = ['visitors', 'visitor_log', 'hellohub_visitors', 'visitor_data', 'visitors'];
            let activeTable = null;
            let recordCount = 0;
            
            // Find the table with data
            for (const tableName of possibleTables) {
                try {
                    console.log(`üîç Checking table: ${tableName}`);
                    const checkResponse = await fetch(`${ADMIN_CONFIG.supabaseUrl}/rest/v1/${tableName}?select=count`, {
                        method: 'HEAD',
                        headers: {
                            'apikey': ADMIN_CONFIG.supabaseAnonKey,
                            'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`
                        }
                    });
                    
                    if (checkResponse.ok) {
                        // Get actual record count
                        const countResponse = await fetch(`${ADMIN_CONFIG.supabaseUrl}/rest/v1/${tableName}?select=id`, {
                            method: 'GET',
                            headers: {
                                'apikey': ADMIN_CONFIG.supabaseAnonKey,
                                'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`
                            }
                        });
                        
                        if (countResponse.ok) {
                            const records = await countResponse.json();
                            if (records.length > 0) {
                                activeTable = tableName;
                                recordCount = records.length;
                                console.log(`‚úÖ Found active table: ${tableName} with ${recordCount} records`);
                                break;
                            }
                        }
                    }
                } catch (error) {
                    console.log(`‚ùå Error checking table ${tableName}:`, error.message);
                }
            }
            
            if (!activeTable) {
                console.log('üìù No active table found with data');
                return { success: true, clearedTables: [], errors: [], message: 'No data found to clear' };
            }
            
            // Now clear the active table
            console.log(`üóëÔ∏è Attempting to clear ${recordCount} records from table: ${activeTable}`);
            
            try {
                // Try different deletion approaches
                const deletionMethods = [
                    // Method 1: Delete all with gte filter
                    {
                        name: 'Delete with id filter',
                        url: `${ADMIN_CONFIG.supabaseUrl}/rest/v1/${activeTable}?id=gte.0`,
                        headers: {
                            'apikey': ADMIN_CONFIG.supabaseAnonKey,
                            'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    },
                    // Method 2: Delete all with neq filter
                    {
                        name: 'Delete with neq filter',
                        url: `${ADMIN_CONFIG.supabaseUrl}/rest/v1/${activeTable}?id=neq.0`,
                        headers: {
                            'apikey': ADMIN_CONFIG.supabaseAnonKey,
                            'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    }
                ];
                
                for (const method of deletionMethods) {
                    console.log(`üîÑ Trying deletion method: ${method.name}`);
                    
                    const response = await fetch(method.url, {
                        method: 'DELETE',
                        headers: method.headers
                    });
                    
                    console.log(`üì° Delete response: ${response.status} ${response.statusText}`);
                    
                    if (response.ok) {
                        console.log(`‚úÖ Successfully cleared table ${activeTable} using ${method.name}`);
                        
                        // Verify deletion worked
                        const verifyResponse = await fetch(`${ADMIN_CONFIG.supabaseUrl}/rest/v1/${activeTable}?select=id`, {
                            method: 'GET',
                            headers: {
                                'apikey': ADMIN_CONFIG.supabaseAnonKey,
                                'Authorization': `Bearer ${ADMIN_CONFIG.supabaseAnonKey}`
                            }
                        });
                        
                        if (verifyResponse.ok) {
                            const remainingRecords = await verifyResponse.json();
                            console.log(`üîç Verification: ${remainingRecords.length} records remaining`);
                            
                            if (remainingRecords.length === 0) {
                                return { 
                                    success: true, 
                                    clearedTables: [activeTable], 
                                    errors: [],
                                    recordsCleared: recordCount,
                                    method: method.name
                                };
                            }
                        }
                    } else {
                        const errorText = await response.text();
                        console.log(`‚ùå Method ${method.name} failed: ${response.status} - ${errorText}`);
                    }
                }
                
                throw new Error(`All deletion methods failed for table ${activeTable}`);
                
            } catch (error) {
                console.error(`‚ùå Failed to clear table ${activeTable}:`, error);
                throw new Error(`Database clearing failed: ${error.message}. Check Supabase permissions.`);
            }
        }

        function exportFeedbackPDF() {
            showExportModal();
        }

        function showExportModal() {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            const formContainer = document.createElement('div');
            formContainer.style.cssText = 'background: white; border-radius: 15px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3);';
            
            // Calculate date ranges for quick selections
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const lastWeek = new Date(today);
            lastWeek.setDate(lastWeek.getDate() - 7);
            const lastMonth = new Date(today);
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const last3Months = new Date(today);
            last3Months.setMonth(last3Months.getMonth() - 3);
            
            const formatDate = (date) => date.toISOString().split('T')[0];
            
            formContainer.innerHTML = `
                <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px;">üìä Export Data</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" 
                                style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; border-radius: 50%; opacity: 0.8; transition: opacity 0.3s;" 
                                onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">√ó</button>
                    </div>
                    <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 14px;">Configure your export parameters and download data</p>
                </div>
                
                <div style="padding: 25px;">
                    <form id="exportForm">
                        
                        <!-- Export Type Selection -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 16px;">üìã Export Type</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: #f8f9fa;">
                                    <input type="radio" name="exportType" value="feedback" checked style="margin-right: 8px; transform: scale(1.2);">
                                    <div>
                                        <div style="font-weight: 600; color: #2c3e50;">Feedback Only</div>
                                        <div style="font-size: 12px; color: #666;">Visitor feedback and ratings</div>
                                    </div>
                                </label>
                                <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: #f8f9fa;">
                                    <input type="radio" name="exportType" value="visitors" style="margin-right: 8px; transform: scale(1.2);">
                                    <div>
                                        <div style="font-weight: 600; color: #2c3e50;">All Visitor Data</div>
                                        <div style="font-size: 12px; color: #666;">Complete visitor records</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Quick Date Range Selection -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 16px;">‚è∞ Quick Date Range</label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 15px;">
                                <button type="button" class="quick-date-btn" data-days="0" style="padding: 8px 12px; border: 2px solid #e0e0e0; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s;">Today</button>
                                <button type="button" class="quick-date-btn" data-days="1" style="padding: 8px 12px; border: 2px solid #e0e0e0; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s;">Yesterday</button>
                                <button type="button" class="quick-date-btn" data-days="7" style="padding: 8px 12px; border: 2px solid #e0e0e0; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s;">Last 7 Days</button>
                                <button type="button" class="quick-date-btn" data-days="30" style="padding: 8px 12px; border: 2px solid #e0e0e0; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s;">Last 30 Days</button>
                                <button type="button" class="quick-date-btn" data-days="90" style="padding: 8px 12px; border: 2px solid #e0e0e0; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s;">Last 3 Months</button>
                                <button type="button" class="quick-date-btn" data-days="all" style="padding: 8px 12px; border: 2px solid #e0e0e0; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s;">All Time</button>
                            </div>
                        </div>
                        
                        <!-- Custom Date Range -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 16px;">üìÖ Custom Date Range</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #2c3e50;">From Date</label>
                                    <input type="date" id="exportFromDate" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #2c3e50;">To Date</label>
                                    <input type="date" id="exportToDate" value="${formatDate(today)}" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filter Options -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 16px;">üîç Filter Options</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #2c3e50;">Location</label>
                                    <select id="exportLocationFilter" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
                                        <option value="">All Locations</option>
                                        <option value="The Royal">The Royal</option>
                                        <option value="The Crown">The Crown</option>
                                        <option value="Seabreeze">Seabreeze</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #2c3e50;">User Type</label>
                                    <select id="exportUserTypeFilter" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
                                        <option value="">All Types</option>
                                        <option value="visitor">Visitors</option>
                                        <option value="client">Clients</option>
                                        <option value="staff">Staff</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #2c3e50;">Status</label>
                                    <select id="exportStatusFilter" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
                                        <option value="">All Statuses</option>
                                        <option value="arrived">Currently Inside</option>
                                        <option value="departed">Completed Visits</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export Format -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 16px;">üíæ Export Format</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: #f8f9fa;">
                                    <input type="radio" name="exportFormat" value="csv" checked style="margin-right: 8px; transform: scale(1.2);">
                                    <div>
                                        <div style="font-weight: 600; color: #2c3e50;">CSV File</div>
                                        <div style="font-size: 12px; color: #666;">Excel-compatible format</div>
                                    </div>
                                </label>
                                <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: #f8f9fa;">
                                    <input type="radio" name="exportFormat" value="json" style="margin-right: 8px; transform: scale(1.2);">
                                    <div>
                                        <div style="font-weight: 600; color: #2c3e50;">JSON File</div>
                                        <div style="font-size: 12px; color: #666;">Developer-friendly format</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Preview Section -->
                        <div style="margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px;">üìä Export Preview</div>
                            <div id="exportPreview" style="font-size: 14px; color: #666;">
                                Click a quick date range or set custom dates to see preview
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                            <button type="button" onclick="this.parentElement.parentElement.parentElement.parentElement.parentElement.remove()" 
                                    style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                Cancel
                            </button>
                            <button type="submit" 
                                    style="flex: 2; padding: 12px; background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                üì• Download Export
                            </button>
                        </div>
                        
                    </form>
                </div>
            `;
            
            modal.appendChild(formContainer);
            document.body.appendChild(modal);
            
            // Add event listeners for radio button styling
            const radioInputs = formContainer.querySelectorAll('input[type="radio"]');
            radioInputs.forEach(input => {
                input.addEventListener('change', function() {
                    // Reset all labels in this group
                    const groupName = this.name;
                    const allLabelsInGroup = formContainer.querySelectorAll(`input[name="${groupName}"]`);
                    allLabelsInGroup.forEach(radio => {
                        const label = radio.closest('label');
                        label.style.borderColor = '#e0e0e0';
                        label.style.background = '#f8f9fa';
                    });
                    
                    // Highlight selected
                    const selectedLabel = this.closest('label');
                    selectedLabel.style.borderColor = '#3498db';
                    selectedLabel.style.background = '#e3f2fd';
                    
                    updateExportPreview();
                });
            });
            
            // Add event listeners for quick date buttons
            const quickDateBtns = formContainer.querySelectorAll('.quick-date-btn');
            quickDateBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Reset all buttons
                    quickDateBtns.forEach(b => {
                        b.style.borderColor = '#e0e0e0';
                        b.style.background = '#f8f9fa';
                        b.style.color = '#333';
                    });
                    
                    // Highlight selected
                    this.style.borderColor = '#3498db';
                    this.style.background = '#3498db';
                    this.style.color = 'white';
                    
                    // Set date range
                    const days = this.dataset.days;
                    const toDate = new Date();
                    let fromDate;
                    
                    if (days === 'all') {
                        fromDate = null;
                        document.getElementById('exportFromDate').value = '';
                    } else if (days === '0') {
                        fromDate = new Date(toDate);
                        document.getElementById('exportFromDate').value = formatDate(fromDate);
                    } else {
                        fromDate = new Date(toDate);
                        fromDate.setDate(fromDate.getDate() - parseInt(days));
                        document.getElementById('exportFromDate').value = formatDate(fromDate);
                    }
                    
                    document.getElementById('exportToDate').value = formatDate(toDate);
                    updateExportPreview();
                });
                
                // Hover effects
                btn.addEventListener('mouseenter', function() {
                    if (this.style.background !== 'rgb(52, 152, 219)') {
                        this.style.borderColor = '#3498db';
                        this.style.background = '#e3f2fd';
                    }
                });
                
                btn.addEventListener('mouseleave', function() {
                    if (this.style.background !== 'rgb(52, 152, 219)') {
                        this.style.borderColor = '#e0e0e0';
                        this.style.background = '#f8f9fa';
                    }
                });
            });
            
            // Add event listeners for filter changes
            const filterInputs = formContainer.querySelectorAll('select, input[type="date"]');
            filterInputs.forEach(input => {
                input.addEventListener('change', updateExportPreview);
                input.addEventListener('focus', function() {
                    this.style.borderColor = '#3498db';
                    this.style.boxShadow = '0 0 0 3px rgba(52, 152, 219, 0.1)';
                });
                input.addEventListener('blur', function() {
                    this.style.borderColor = '#e0e0e0';
                    this.style.boxShadow = 'none';
                });
            });
            
            // Handle form submission
            document.getElementById('exportForm').addEventListener('submit', function(e) {
                e.preventDefault();
                processExport();
            });
            
            // Initial preview update
            updateExportPreview();
        }
        
        function updateExportPreview() {
            const exportType = document.querySelector('input[name="exportType"]:checked').value;
            const fromDate = document.getElementById('exportFromDate').value;
            const toDate = document.getElementById('exportToDate').value;
            const location = document.getElementById('exportLocationFilter').value;
            const userType = document.getElementById('exportUserTypeFilter').value;
            const status = document.getElementById('exportStatusFilter').value;
            
            // Filter data based on selection
            let filteredData = [...allVisitorData];
            
            // Date filtering
            if (fromDate || toDate) {
                filteredData = filteredData.filter(visitor => {
                    const visitDate = visitor.arrivalDate || visitor.timestamp.toISOString().split('T')[0];
                    const dateCheck = new Date(visitDate);
                    
                    if (fromDate && dateCheck < new Date(fromDate)) return false;
                    if (toDate && dateCheck > new Date(toDate + ' 23:59:59')) return false;
                    return true;
                });
            }
            
            // Location filtering
            if (location) {
                filteredData = filteredData.filter(visitor => visitor.location === location);
            }
            
            // User type filtering
            if (userType) {
                filteredData = filteredData.filter(visitor => visitor.userType === userType);
            }
            
            // Status filtering
            if (status) {
                filteredData = filteredData.filter(visitor => visitor.status === status);
            }
            
            // Export type filtering
            if (exportType === 'feedback') {
                filteredData = filteredData.filter(visitor => visitor.userType === 'visitor' && visitor.feedback);
            }
            
            // Update preview
            const previewEl = document.getElementById('exportPreview');
            if (filteredData.length === 0) {
                previewEl.innerHTML = '‚ö†Ô∏è No records match the selected criteria';
                previewEl.style.color = '#e74c3c';
            } else {
                const dateRangeText = fromDate && toDate ? 
                    `${fromDate} to ${toDate}` : 
                    fromDate ? `From ${fromDate}` :
                    toDate ? `Up to ${toDate}` : 'All dates';
                
                previewEl.innerHTML = `
                    ‚úÖ <strong>${filteredData.length}</strong> records will be exported<br>
                    üìÖ Date range: ${dateRangeText}<br>
                    üìä Type: ${exportType === 'feedback' ? 'Feedback only' : 'All visitor data'}
                    ${location ? `<br>üìç Location: ${location}` : ''}
                    ${userType ? `<br>üë§ User type: ${userType}` : ''}
                    ${status ? `<br>üìã Status: ${status}` : ''}
                `;
                previewEl.style.color = '#27ae60';
            }
        }
        
        function processExport() {
            const exportType = document.querySelector('input[name="exportType"]:checked').value;
            const exportFormat = document.querySelector('input[name="exportFormat"]:checked').value;
            const fromDate = document.getElementById('exportFromDate').value;
            const toDate = document.getElementById('exportToDate').value;
            const location = document.getElementById('exportLocationFilter').value;
            const userType = document.getElementById('exportUserTypeFilter').value;
            const status = document.getElementById('exportStatusFilter').value;
            
            // Filter data based on selection
            let filteredData = [...allVisitorData];
            
            // Date filtering
            if (fromDate || toDate) {
                filteredData = filteredData.filter(visitor => {
                    const visitDate = visitor.arrivalDate || visitor.timestamp.toISOString().split('T')[0];
                    const dateCheck = new Date(visitDate);
                    
                    if (fromDate && dateCheck < new Date(fromDate)) return false;
                    if (toDate && dateCheck > new Date(toDate + ' 23:59:59')) return false;
                    return true;
                });
            }
            
            // Apply other filters
            if (location) filteredData = filteredData.filter(visitor => visitor.location === location);
            if (userType) filteredData = filteredData.filter(visitor => visitor.userType === userType);
            if (status) filteredData = filteredData.filter(visitor => visitor.status === status);
            
            // Export type filtering
            if (exportType === 'feedback') {
                filteredData = filteredData.filter(visitor => visitor.userType === 'visitor' && visitor.feedback);
            }
            
            if (filteredData.length === 0) {
                showNotification('‚ùå No data matches the selected criteria!', 'error');
                return;
            }
            
            // Generate filename
            const dateStr = new Date().toISOString().split('T')[0];
            const typeStr = exportType === 'feedback' ? 'feedback' : 'visitors';
            const rangeStr = fromDate && toDate ? `_${fromDate}_to_${toDate}` : 
                           fromDate ? `_from_${fromDate}` :
                           toDate ? `_to_${toDate}` : '';
            const filename = `${typeStr}-export${rangeStr}_${dateStr}.${exportFormat}`;
            
            try {
                if (exportFormat === 'csv') {
                    exportAsCSV(filteredData, exportType, filename);
                } else {
                    exportAsJSON(filteredData, exportType, filename);
                }
                
                // Close modal
                const modal = document.body.querySelector('div[style*="position: fixed"]');
                if (modal) modal.remove();
                
                showNotification(`‚úÖ Exported ${filteredData.length} records as ${exportFormat.toUpperCase()}!`, 'success');
                
            } catch (error) {
                console.error('Export failed:', error);
                showNotification('‚ùå Export failed. Please try again.', 'error');
            }
        }
        
        function exportAsCSV(data, exportType, filename) {
            let headers, csvContent;
            
            if (exportType === 'feedback') {
                headers = [
                    'Date', 'Time', 'Visitor Name', 'Location', 'Email', 'Mobile',
                    'Overall Rating', 'Safety Rating', 'Responsive Rating', 'Caring Rating', 
                    'Leadership Rating', 'Effectiveness Rating', 'Average Rating', 'Additional Comments'
                ];
                
                csvContent = headers.join(',') + '\n';
                
                data.forEach(visitor => {
                    const feedback = visitor.feedback;
                    const avgRating = calculateAverageRating(feedback);
                    
                    const row = [
                        visitor.arrivalDate || visitor.timestamp.toLocaleDateString(),
                        visitor.arrivalTime || visitor.timestamp.toLocaleTimeString(),
                        `"${visitor.firstName} ${visitor.surname}"`,
                        visitor.location,
                        visitor.email,
                        visitor.mobile,
                        feedback.overall || 0,
                        feedback.safety || 0,
                        feedback.responsive || 0,
                        feedback.caring || 0,
                        feedback.leadership || 0,
                        feedback.effectiveness || 0,
                        avgRating.toFixed(1),
                        `"${feedback.additionalComments || 'No comments'}"`
                    ];
                    
                    csvContent += row.join(',') + '\n';
                });
            } else {
                headers = [
                    'Date', 'First Name', 'Surname', 'Email', 'Mobile', 'User Type', 'Location',
                    'Arrival Date', 'Arrival Time', 'Departure Date', 'Departure Time', 'Status', 'Visit Duration',
                    'Has Feedback', 'Average Rating'
                ];
                
                csvContent = headers.join(',') + '\n';
                
                data.forEach(visitor => {
                    // Calculate visit duration
                    let duration = '';
                    if (visitor.arrivalTime && visitor.departureTime && visitor.arrivalDate && visitor.departureDate) {
                        try {
                            const arrivalDateTime = new Date(`${visitor.arrivalDate} ${visitor.arrivalTime}`);
                            const departureDateTime = new Date(`${visitor.departureDate} ${visitor.departureTime}`);
                            const durationMs = departureDateTime - arrivalDateTime;
                            
                            if (durationMs > 0) {
                                const hours = Math.floor(durationMs / (1000 * 60 * 60));
                                const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                                duration = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                            }
                        } catch (error) {
                            duration = '';
                        }
                    }
                    
                    const avgRating = visitor.feedback ? calculateAverageRating(visitor.feedback).toFixed(1) : '';
                    
                    const row = [
                        visitor.arrivalDate || visitor.timestamp.toLocaleDateString(),
                        `"${visitor.firstName}"`,
                        `"${visitor.surname}"`,
                        visitor.email,
                        visitor.mobile,
                        visitor.userType,
                        visitor.location,
                        visitor.arrivalDate || '',
                        visitor.arrivalTime || '',
                        visitor.departureDate || '',
                        visitor.departureTime || '',
                        visitor.status,
                        duration,
                        visitor.feedback ? 'Yes' : 'No',
                        avgRating
                    ];
                    
                    csvContent += row.join(',') + '\n';
                });
            }
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportAsJSON(data, exportType, filename) {
            let exportData;
            
            if (exportType === 'feedback') {
                exportData = {
                    exportType: 'feedback',
                    exportDate: new Date().toISOString(),
                    recordCount: data.length,
                    data: data.map(visitor => ({
                        date: visitor.arrivalDate || visitor.timestamp.toISOString().split('T')[0],
                        time: visitor.arrivalTime || visitor.timestamp.toTimeString().slice(0,8),
                        visitorName: `${visitor.firstName} ${visitor.surname}`,
                        location: visitor.location,
                        email: visitor.email,
                        mobile: visitor.mobile,
                        feedback: {
                            overall: visitor.feedback.overall || 0,
                            safety: visitor.feedback.safety || 0,
                            responsive: visitor.feedback.responsive || 0,
                            caring: visitor.feedback.caring || 0,
                            leadership: visitor.feedback.leadership || 0,
                            effectiveness: visitor.feedback.effectiveness || 0,
                            averageRating: calculateAverageRating(visitor.feedback),
                            additionalComments: visitor.feedback.additionalComments || 'No comments'
                        }
                    }))
                };
            } else {
                exportData = {
                    exportType: 'visitors',
                    exportDate: new Date().toISOString(),
                    recordCount: data.length,
                    data: data.map(visitor => {
                        // Calculate visit duration
                        let durationMinutes = null;
                        if (visitor.arrivalTime && visitor.departureTime && visitor.arrivalDate && visitor.departureDate) {
                            try {
                                const arrivalDateTime = new Date(`${visitor.arrivalDate} ${visitor.arrivalTime}`);
                                const departureDateTime = new Date(`${visitor.departureDate} ${visitor.departureTime}`);
                                const durationMs = departureDateTime - arrivalDateTime;
                                
                                if (durationMs > 0) {
                                    durationMinutes = Math.floor(durationMs / (1000 * 60));
                                }
                            } catch (error) {
                                durationMinutes = null;
                            }
                        }
                        
                        const visitorData = {
                            id: visitor.id,
                            firstName: visitor.firstName,
                            surname: visitor.surname,
                            email: visitor.email,
                            mobile: visitor.mobile,
                            userType: visitor.userType,
                            location: visitor.location,
                            arrivalDate: visitor.arrivalDate || '',
                            arrivalTime: visitor.arrivalTime || '',
                            departureDate: visitor.departureDate || '',
                            departureTime: visitor.departureTime || '',
                            status: visitor.status,
                            visitDurationMinutes: durationMinutes,
                            timestamp: visitor.timestamp.toISOString(),
                            hasFeedback: !!visitor.feedback
                        };
                        
                        // Include feedback data if it exists
                        if (visitor.feedback) {
                            visitorData.feedback = {
                                overall: visitor.feedback.overall || 0,
                                safety: visitor.feedback.safety || 0,
                                responsive: visitor.feedback.responsive || 0,
                                caring: visitor.feedback.caring || 0,
                                leadership: visitor.feedback.leadership || 0,
                                effectiveness: visitor.feedback.effectiveness || 0,
                                averageRating: calculateAverageRating(visitor.feedback),
                                additionalComments: visitor.feedback.additionalComments || 'No comments'
                            };
                        }
                        
                        return visitorData;
                    })
                };
            }
            
            // Download JSON
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
}

        // Check for existing session on load
        function checkExistingSession() {
            const savedSession = localStorage.getItem('hellohubAdminSession');
            
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    if (sessionData.isLoggedIn) {
                        isLoggedIn = true;
                        showDashboard();
                        return;
                    }
                } catch (error) {
                    console.log('Invalid session data');
                }
            }
            
            // Show login screen
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardContent').style.display = 'none';
        }

        // Auto-refresh every 30 seconds - SILENT (with global reference)
        window.autoRefreshInterval = setInterval(() => {
            if (isLoggedIn) {
                loadVisitorData(false); // false = silent refresh (no notifications)
            }
        }, 30000);

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè¢ Admin Dashboard initialized');
            checkExistingSession();
        });
    </script>
</body>
</html>

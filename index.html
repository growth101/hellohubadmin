<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alex Davis Care Group - Admin Dashboard</title>
    <link rel="icon" type="image/png" sizes="32x32" href="alex-davis-favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="alex-davis-favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="alex-davis-favicon.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 10px;
        }
        .dashboard-container {
            max-width: 1200px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.98); border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15); overflow: hidden;
            backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2);
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white; padding: 30px 20px; text-align: center;
            position: relative; overflow: hidden;
        }
        .header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
        }
        .header .company-logo {
            max-height: 60px;
            max-width: 200px;
            width: auto;
            height: auto;
            margin-bottom: 15px;
            object-fit: contain;
        }
        .header h1 { font-size: 28px; margin-bottom: 8px; font-weight: 300; position: relative; z-index: 1; }
        .header p { opacity: 0.9; font-size: 14px; font-weight: 300; position: relative; z-index: 1; }
        .controls {
            padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
        }
        .btn {
            padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: 500; transition: all 0.3s ease; font-size: 13px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
            color: white; 
        }
        .btn-success { 
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%); 
            color: white; 
        }
        .btn-warning { 
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); 
            color: white; 
        }
        .btn:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 20px rgba(0,0,0,0.15); 
        }
        .btn:active { 
            transform: translateY(0); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        .stats {
            padding: 20px 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 20px 15px; border-radius: 12px; text-align: center;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        .stat-number { 
            font-size: 28px; font-weight: 600; color: #2c3e50; 
            margin-bottom: 6px; 
        }
        .stat-label { 
            color: #7f8c8d; font-size: 12px; font-weight: 500; 
            text-transform: uppercase; letter-spacing: 0.5px; 
        }
        .data-section { padding: 20px 15px; background: #ffffff; }
        .section-title { 
            font-size: 18px; font-weight: 600; margin-bottom: 15px; 
            color: #2c3e50; 
        }
        .visitor-table {
            width: 100%; border-collapse: collapse; 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
            border-radius: 12px; overflow: hidden; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }
        .visitor-table th, .visitor-table td {
            padding: 12px 8px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.06);
            font-size: 13px;
        }
        .visitor-table th {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white; font-weight: 600; font-size: 12px;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .visitor-table tr:hover { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%); 
        }
        .status-badge {
            padding: 4px 8px; border-radius: 16px; font-size: 10px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .status-arrived { 
            background: linear-gradient(135deg, #d4f6d4 0%, #c8e6c9 100%); 
            color: #2e7d32; border: 1px solid #a5d6a7; 
        }
        .status-departed { 
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); 
            color: #c62828; border: 1px solid #ef9a9a; 
        }
        .loading { 
            text-align: center; padding: 40px 20px; color: #7f8c8d; 
            font-size: 14px; font-weight: 300; 
        }
        .error { 
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); 
            color: #c62828; padding: 15px; border-radius: 10px; margin: 15px; 
            border: 1px solid #ef9a9a; font-size: 14px;
        }
        .filters {
            display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
            width: 100%;
        }
        .filter-input {
            padding: 8px 12px; border: 2px solid rgba(0,0,0,0.1); 
            border-radius: 8px; font-size: 13px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            transition: all 0.3s ease; min-width: 120px;
        }
        .filter-input:focus { 
            outline: none; border-color: #3498db; 
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
            background: #ffffff;
        }
        .recent-activity {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
            border-radius: 12px; padding: 20px 15px; margin-top: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .activity-item {
            padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.06); 
            display: flex; justify-content: space-between; align-items: center;
            transition: all 0.3s ease; font-size: 13px;
        }
        .activity-item:hover {
            padding-left: 8px;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.05) 0%, transparent 100%);
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-time { color: #7f8c8d; font-size: 11px; font-weight: 500; }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            body { padding: 5px; }
            
            .dashboard-container { border-radius: 16px; }
            
            .header { padding: 20px 15px; }
            .header h1 { font-size: 24px; }
            .header p { font-size: 13px; }
            
            .controls { 
                padding: 12px; 
                flex-direction: column; 
                align-items: stretch; 
                gap: 12px; 
            }
            
            .btn { 
                width: 100%; 
                padding: 12px; 
                font-size: 14px; 
                text-align: center; 
            }
            
            .filters { 
                flex-direction: column; 
                gap: 10px; 
                align-items: stretch; 
            }
            
            .filter-input { 
                width: 100%; 
                min-width: auto; 
                padding: 10px; 
            }
            
            .stats { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 12px; 
                padding: 15px 10px; 
            }
            
            .stat-card { padding: 15px 10px; }
            .stat-number { font-size: 24px; }
            .stat-label { font-size: 11px; }
            
            .data-section { padding: 15px 10px; }
            .section-title { font-size: 16px; }
            
            /* Mobile table - hide less important columns but keep contact info */
            .visitor-table th:nth-child(6),
            .visitor-table td:nth-child(6),
            .visitor-table th:nth-child(7),
            .visitor-table td:nth-child(7) {
                display: none;
            }
            
            .visitor-table th, .visitor-table td {
                padding: 8px 4px;
                font-size: 12px;
            }
            
            .visitor-table td:nth-child(10) button {
                padding: 6px 8px !important;
                font-size: 10px !important;
                margin-right: 3px !important;
                display: block !important;
                width: 100% !important;
                margin-bottom: 4px !important;
            }
            
            .recent-activity { padding: 15px 10px; }
            .activity-item { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 5px; 
                padding: 10px 0; 
            }
        }

        @media (max-width: 480px) {
            .stats { grid-template-columns: 1fr 1fr; }
            
            .visitor-table {
                font-size: 11px;
            }
            
            /* On very small screens, hide arrival/departure columns but keep contact */
            .visitor-table th:nth-child(6),
            .visitor-table td:nth-child(6),
            .visitor-table th:nth-child(7),
            .visitor-table td:nth-child(7) {
                display: none;
            }
            
            .status-badge {
                font-size: 9px;
                padding: 3px 6px;
            }
        }

        .feedback-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .feedback-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <img src="alex-davis-logo.png" alt="Alex Davis Care Group Logo" class="company-logo">
            <h1>Alex Davis Care Group</h1>
            <p>üìä HelloHub Admin Dashboard</p>
            <p style="font-size: 13px; margin-top: 5px;">Real-time visitor management and analytics</p>
            <div style="position: absolute; top: 10px; right: 15px; font-size: 10px; opacity: 0.7;">
                Configured for: Alex Davis Care Group
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="loadVisitorData()">üîÑ Refresh Data</button>
            <button class="btn btn-success" onclick="showAddVisitorForm()">‚ûï Add Visitor</button>
            <button class="btn btn-warning" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            <button class="btn btn-primary" onclick="exportFeedbackPDF()">üìä Export Feedback</button>
            
            <div class="filters">
                <input type="text" class="filter-input" id="searchFilter" placeholder="Search visitors..." onkeyup="filterData()">
                <select class="filter-input" id="locationFilter" onchange="filterData()">
                    <option value="">All Locations</option>
                    <option value="The Royal">The Royal</option>
                    <option value="The Crown">The Crown</option>
                    <option value="Seabreeze">Seabreeze</option>
                </select>
                <select class="filter-input" id="statusFilter" onchange="filterData()">
                    <option value="">All Status</option>
                    <option value="arrived">Arrived</option>
                    <option value="departed">Departed</option>
                </select>
            </div>
        </div>

        <!-- Add Visitor Modal -->
        <div id="addVisitorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;">
                <h3 style="margin-bottom: 20px; color: #333;">‚ûï Add Visitor Record</h3>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">First Name:</label>
                    <input type="text" id="modalFirstName" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Surname:</label>
                    <input type="text" id="modalSurname" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                    <input type="email" id="modalEmail" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mobile:</label>
                    <input type="tel" id="modalMobile" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">User Type:</label>
                    <select id="modalUserType" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="visitor">Visitor</option>
                        <option value="client">Client</option>
                        <option value="staff">Staff</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Location:</label>
                    <select id="modalLocation" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="The Royal">The Royal</option>
                        <option value="The Crown">The Crown</option>
                        <option value="Seabreeze">Seabreeze</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Status:</label>
                    <select id="modalStatus" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="arrived">Arrived</option>
                        <option value="departed">Departed</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="addVisitorRecord()" style="flex: 1;">‚úÖ Add Visitor</button>
                    <button class="btn" onclick="hideAddVisitorForm()" style="flex: 1; background: #6c757d; color: white;">‚ùå Cancel</button>
                </div>
            </div>
        </div>

        <!-- Feedback Details Modal -->
        <div id="feedbackModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-bottom: 20px; color: #333;">üìã Visitor Feedback Details</h3>
                <div id="feedbackContent">
                    <!-- Feedback details will be populated here -->
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn" onclick="closeFeedbackModal()" style="background: #6c757d; color: white;">Close</button>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalVisitors">-</div>
                <div class="stat-label">Total Visitors</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="currentlyInside">-</div>
                <div class="stat-label">Currently Inside</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayArrivals">-</div>
                <div class="stat-label">Today's Arrivals</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="averageVisitTime">-</div>
                <div class="stat-label">Avg Visit Time</div>
            </div>
        </div>

        <div class="data-section">
            <div class="section-title">üìã Visitor Log</div>
            <div id="dataDisplay" class="loading">
                Click "Refresh Data" to load visitor information
            </div>
        </div>

        <div class="recent-activity">
            <div class="section-title">üïí Recent Activity</div>
            <div id="recentActivity">
                <div class="activity-item">
                    <span>No recent activity</span>
                    <span class="activity-time">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_CONFIG = {
            googleSheetsUrl: 'https://script.google.com/macros/s/AKfycbxasgHvqyBS4BCDeH5Ipm3798X1mZyciwCuuVL20D-Z-8hol6jWfRKWUbqvuPMLyM2C/exec',
            refreshInterval: 30000
        };

        let allVisitorData = JSON.parse(localStorage.getItem('hellohubVisitors') || '[]');
        let filteredData = [];

        function loadVisitorData() {
            document.getElementById('dataDisplay').innerHTML = '<div class="loading">üîÑ Refreshing visitor data...</div>';
            
            const refreshBtn = document.querySelector('button[onclick="loadVisitorData()"]');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '‚è≥ Refreshing...';
            refreshBtn.disabled = true;
            
            setTimeout(() => {
                const rawData = localStorage.getItem('hellohubVisitors');
                allVisitorData = JSON.parse(rawData || '[]');
                
                console.log('üìä Loaded visitor data:', allVisitorData.length, 'records');
                
                allVisitorData = allVisitorData.map(visitor => ({
                    ...visitor,
                    timestamp: new Date(visitor.timestamp)
                }));

                displayVisitorData();
                updateStats();
                updateRecentActivity();
                
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
                
                // Remove the popup messages
            }, 500);
        }

        function showMessage(text, type = 'info') {
            const existingMsg = document.querySelector('.temp-message');
            if (existingMsg) existingMsg.remove();
            
            const message = document.createElement('div');
            message.className = 'temp-message';
            message.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1001;
                padding: 15px 20px; border-radius: 8px; font-weight: bold;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                transform: translateX(400px); transition: all 0.3s ease;
                ${type === 'success' ? 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;' : ''}
                ${type === 'info' ? 'background: #e3f2fd; color: #0277bd; border: 1px solid #b3e5fc;' : ''}
                ${type === 'error' ? 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;' : ''}
            `;
            message.textContent = text;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                message.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 300);
            }, 3000);
        }

        function saveVisitorData() {
            localStorage.setItem('hellohubVisitors', JSON.stringify(allVisitorData));
        }

        function showAddVisitorForm() {
            document.getElementById('addVisitorModal').style.display = 'block';
        }

        function hideAddVisitorForm() {
            document.getElementById('addVisitorModal').style.display = 'none';
            document.getElementById('modalFirstName').value = '';
            document.getElementById('modalSurname').value = '';
            document.getElementById('modalEmail').value = '';
            document.getElementById('modalMobile').value = '';
            document.getElementById('modalUserType').value = 'visitor';
            document.getElementById('modalLocation').value = 'The Royal';
            document.getElementById('modalStatus').value = 'arrived';
        }

        function addVisitorRecord() {
            const firstName = document.getElementById('modalFirstName').value.trim();
            const surname = document.getElementById('modalSurname').value.trim();
            
            if (!firstName || !surname) {
                showMessage('‚ùå Please enter both first name and surname.', 'error');
                return;
            }

            const now = new Date();
            const newVisitor = {
                timestamp: now.toISOString(),
                firstName: firstName,
                surname: surname,
                email: document.getElementById('modalEmail').value.trim() || 'Not provided',
                mobile: document.getElementById('modalMobile').value.trim() || 'Not provided',
                userType: document.getElementById('modalUserType').value,
                location: document.getElementById('modalLocation').value,
                arrivalDate: now.toLocaleDateString(),
                arrivalTime: now.toLocaleTimeString(),
                departureDate: document.getElementById('modalStatus').value === 'departed' ? now.toLocaleDateString() : '',
                departureTime: document.getElementById('modalStatus').value === 'departed' ? now.toLocaleTimeString() : '',
                status: document.getElementById('modalStatus').value
            };

            allVisitorData.unshift(newVisitor);
            saveVisitorData();
            hideAddVisitorForm();
            loadVisitorData();
            
            showMessage(`‚úÖ ${firstName} ${surname} has been added to the visitor log!`, 'success');
        }

        function displayVisitorData() {
            filteredData = [...allVisitorData];
            
            if (filteredData.length === 0) {
                document.getElementById('dataDisplay').innerHTML = 
                    '<div class="loading">No visitor data found. Use HelloHub check-in system or click "‚ûï Add Visitor" to add records.</div>';
                return;
            }

            let tableHTML = `
                <table class="visitor-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Contact</th>
                            <th>Arrival</th>
                            <th>Departure</th>
                            <th>Status</th>
                            <th>Feedback</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredData.forEach((visitor, index) => {
                const statusClass = visitor.status === 'arrived' ? 'status-arrived' : 'status-departed';
                const toggleAction = visitor.status === 'arrived' ? 'Check Out' : 'Check In';
                
                let feedbackHTML = '-';
                console.log('Checking visitor:', visitor.firstName, visitor.surname, 'Feedback:', visitor.feedback);
                
                if (visitor.feedback && visitor.userType === 'visitor') {
                    const avg = calculateAverageRating(visitor.feedback);
                    console.log('Average rating calculated:', avg);
                    feedbackHTML = `
                        <div style="text-align: center;">
                            <div style="color: #f39c12; font-weight: bold; margin-bottom: 4px;">
                                ${generateStars(avg)} <small>(${avg.toFixed(1)})</small>
                            </div>
                            <button class="btn" style="padding: 3px 8px; font-size: 10px; background: #17a2b8; color: white;" 
                                    onclick="showFeedbackDetails(${allVisitorData.indexOf(visitor)})">View Details</button>
                        </div>
                    `;
                } else if (visitor.userType === 'visitor' && visitor.status === 'departed') {
                    feedbackHTML = '<small style="color: #999;">No feedback provided</small>';
                }
                
                tableHTML += `
                    <tr>
                        <td>${new Date(visitor.timestamp).toLocaleTimeString()}</td>
                        <td><strong>${visitor.firstName} ${visitor.surname}</strong></td>
                        <td>${visitor.userType.charAt(0).toUpperCase() + visitor.userType.slice(1)}</td>
                        <td>${visitor.location}</td>
                        <td>${visitor.email}<br><small>${visitor.mobile}</small></td>
                        <td>${visitor.arrivalTime || '-'}</td>
                        <td>${visitor.departureTime || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${visitor.status.toUpperCase()}</span></td>
                        <td>${feedbackHTML}</td>
                        <td>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #17a2b8; color: white; margin-right: 5px;" 
                                    onclick="toggleVisitorStatus(${allVisitorData.indexOf(visitor)})">${toggleAction}</button>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #dc3545; color: white;" 
                                    onclick="deleteVisitor(${allVisitorData.indexOf(visitor)})">Delete</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            document.getElementById('dataDisplay').innerHTML = tableHTML;
        }

        function toggleVisitorStatus(index) {
            if (index >= 0 && index < allVisitorData.length) {
                const visitor = allVisitorData[index];
                const now = new Date();
                
                if (visitor.status === 'arrived') {
                    visitor.status = 'departed';
                    visitor.departureDate = now.toLocaleDateString();
                    visitor.departureTime = now.toLocaleTimeString();
                } else {
                    visitor.status = 'arrived';
                    visitor.departureDate = '';
                    visitor.departureTime = '';
                }
                
                saveVisitorData();
                loadVisitorData();
                alert(`‚úÖ ${visitor.firstName} ${visitor.surname} has been ${visitor.status === 'arrived' ? 'checked in' : 'checked out'}`);
            }
        }

        function deleteVisitor(index) {
            if (index >= 0 && index < allVisitorData.length) {
                const visitor = allVisitorData[index];
                if (confirm(`‚ö†Ô∏è Are you sure you want to delete ${visitor.firstName} ${visitor.surname}'s record?`)) {
                    allVisitorData.splice(index, 1);
                    saveVisitorData();
                    loadVisitorData();
                    alert(`üóëÔ∏è ${visitor.firstName} ${visitor.surname}'s record has been deleted.`);
                }
            }
        }

        function updateStats() {
            const total = allVisitorData.length;
            const currentlyInside = allVisitorData.filter(v => v.status === 'arrived').length;
            const today = new Date().toLocaleDateString();
            const todayArrivals = allVisitorData.filter(v => v.arrivalDate === today).length;

            document.getElementById('totalVisitors').textContent = total;
            document.getElementById('currentlyInside').textContent = currentlyInside;
            document.getElementById('todayArrivals').textContent = todayArrivals;
            document.getElementById('averageVisitTime').textContent = '2.5h';
        }

        function updateRecentActivity() {
            const recent = allVisitorData
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 5);

            let activityHTML = '';
            recent.forEach(visitor => {
                const action = visitor.status === 'arrived' ? 'checked in' : 'checked out';
                activityHTML += `
                    <div class="activity-item">
                        <span><strong>${visitor.firstName} ${visitor.surname}</strong> ${action} at ${visitor.location}</span>
                        <span class="activity-time">${visitor.timestamp.toLocaleTimeString()}</span>
                    </div>
                `;
            });

            if (activityHTML === '') {
                activityHTML = '<div class="activity-item"><span>No recent activity</span><span class="activity-time">-</span></div>';
            }

            document.getElementById('recentActivity').innerHTML = activityHTML;
        }

        function filterData() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredData = allVisitorData.filter(visitor => {
                const matchesSearch = searchTerm === '' || 
                    visitor.firstName.toLowerCase().includes(searchTerm) ||
                    visitor.surname.toLowerCase().includes(searchTerm) ||
                    visitor.email.toLowerCase().includes(searchTerm);

                const matchesLocation = locationFilter === '' || visitor.location === locationFilter;
                const matchesStatus = statusFilter === '' || visitor.status === statusFilter;

                return matchesSearch && matchesLocation && matchesStatus;
            });

            displayFilteredData(); // Use a separate function for filtered display
        }

        function displayFilteredData() {
            if (filteredData.length === 0) {
                document.getElementById('dataDisplay').innerHTML = 
                    '<div class="loading">No visitors match your filter criteria.</div>';
                return;
            }

            let tableHTML = `
                <table class="visitor-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Contact</th>
                            <th>Arrival</th>
                            <th>Departure</th>
                            <th>Status</th>
                            <th>Feedback</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredData.forEach((visitor, index) => {
                const statusClass = visitor.status === 'arrived' ? 'status-arrived' : 'status-departed';
                const toggleAction = visitor.status === 'arrived' ? 'Check Out' : 'Check In';
                
                let feedbackHTML = '-';
                console.log('Checking visitor:', visitor.firstName, visitor.surname, 'Feedback:', visitor.feedback);
                
                if (visitor.feedback && visitor.userType === 'visitor') {
                    const avg = calculateAverageRating(visitor.feedback);
                    console.log('Average rating calculated:', avg);
                    feedbackHTML = `
                        <div style="text-align: center;">
                            <div style="color: #f39c12; font-weight: bold; margin-bottom: 4px;">
                                ${generateStars(avg)} <small>(${avg.toFixed(1)})</small>
                            </div>
                            <button class="btn" style="padding: 3px 8px; font-size: 10px; background: #17a2b8; color: white;" 
                                    onclick="showFeedbackDetails(${allVisitorData.indexOf(visitor)})">View Details</button>
                        </div>
                    `;
                } else if (visitor.userType === 'visitor' && visitor.status === 'departed') {
                    feedbackHTML = '<small style="color: #999;">No feedback provided</small>';
                }
                
                tableHTML += `
                    <tr>
                        <td>${new Date(visitor.timestamp).toLocaleTimeString()}</td>
                        <td><strong>${visitor.firstName} ${visitor.surname}</strong></td>
                        <td>${visitor.userType.charAt(0).toUpperCase() + visitor.userType.slice(1)}</td>
                        <td>${visitor.location}</td>
                        <td>${visitor.email}<br><small>${visitor.mobile}</small></td>
                        <td>${visitor.arrivalTime || '-'}</td>
                        <td>${visitor.departureTime || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${visitor.status.toUpperCase()}</span></td>
                        <td>${feedbackHTML}</td>
                        <td>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #17a2b8; color: white; margin-right: 5px;" 
                                    onclick="toggleVisitorStatus(${allVisitorData.indexOf(visitor)})">${toggleAction}</button>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #dc3545; color: white;" 
                                    onclick="deleteVisitor(${allVisitorData.indexOf(visitor)})">Delete</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            document.getElementById('dataDisplay').innerHTML = tableHTML;
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear ALL visitor data? This cannot be undone!')) {
                allVisitorData = [];
                saveVisitorData();
                loadVisitorData();
                alert('üóëÔ∏è All visitor data has been cleared.');
            }
        }

        function calculateAverageRating(feedback) {
            const ratings = [
                feedback.overall,
                feedback.safety,
                feedback.responsive,
                feedback.caring,
                feedback.leadership,
                feedback.effectiveness
            ].filter(rating => rating > 0);
            
            if (ratings.length === 0) return 0;
            return ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length;
        }

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let stars = '';
            
            for (let i = 0; i < fullStars; i++) {
                stars += '‚≠ê';
            }
            if (hasHalfStar) {
                stars += '‚ú®';
            }
            
            return stars || '‚òÜ';
        }

        function showFeedbackDetails(visitorIndex) {
            const visitor = allVisitorData[visitorIndex];
            if (!visitor.feedback) return;
            
            const feedback = visitor.feedback;
            const avgRating = calculateAverageRating(feedback);
            
            const feedbackHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">${visitor.firstName} ${visitor.surname}</h4>
                    <div style="font-size: 24px; color: #f39c12; margin-bottom: 5px;">
                        ${generateStars(avgRating)}
                    </div>
                    <div style="color: #7f8c8d; font-size: 14px;">
                        Average Rating: ${avgRating.toFixed(1)} / 5.0
                    </div>
                </div>
                
                <div style="display: grid; gap: 15px;">
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Overall Experience:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.overall)} (${feedback.overall}/5)</span>
                    </div>
                    
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Keeps People Safe:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.safety)} (${feedback.safety}/5)</span>
                    </div>
                    
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Responsive to Needs:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.responsive)} (${feedback.responsive}/5)</span>
                    </div>
                    
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Caring Towards People:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.caring)} (${feedback.caring}/5)</span>
                    </div>
                    
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Well-Led:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.leadership)} (${feedback.leadership}/5)</span>
                    </div>
                    
                    <div class="feedback-item">
                        <span style="font-weight: bold;">Effective Care:</span>
                        <span style="float: right; color: #f39c12;">${generateStars(feedback.effectiveness)} (${feedback.effectiveness}/5)</span>
                    </div>
                    
                    ${feedback.additionalComments && feedback.additionalComments !== 'No additional comments' ? `
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                        <span style="font-weight: bold; color: #2c3e50;">Additional Comments:</span>
                        <p style="margin-top: 8px; color: #555; font-style: italic;">"${feedback.additionalComments}"</p>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('feedbackContent').innerHTML = feedbackHTML;
            document.getElementById('feedbackModal').style.display = 'block';
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'none';
        }

        function exportFeedbackPDF() {
            console.log('PDF export function called');
            
            const feedbackData = allVisitorData.filter(visitor => 
                visitor.userType === 'visitor' && visitor.feedback
            );
            
            console.log('Available feedback records for PDF:', feedbackData.length);
            
            if (feedbackData.length === 0) {
                showMessage('No feedback data found to export!', 'error');
                return;
            }
            
            // Generate CSV content instead of PDF for better compatibility
            const csvContent = generateFeedbackCSV(feedbackData);
            
            // Try to download as CSV file
            try {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `feedback-report-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage(`‚úÖ Exported ${feedbackData.length} feedback records as CSV!`, 'success');
            } catch (error) {
                console.error('Download failed:', error);
                // Fallback to showing the data
                showExportFallback(csvContent, feedbackData.length);
            }
        }

        function generateFeedbackCSV(feedbackData) {
            const headers = [
                'Date', 'Time', 'Visitor Name', 'Location', 'Email', 'Mobile',
                'Overall Rating', 'Safety Rating', 'Responsive Rating', 'Caring Rating', 
                'Leadership Rating', 'Effectiveness Rating', 'Average Rating', 'Additional Comments'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            feedbackData.forEach(visitor => {
                const feedback = visitor.feedback;
                const avgRating = calculateAverageRating(feedback);
                
                const row = [
                    new Date(visitor.timestamp).toLocaleDateString(),
                    new Date(visitor.timestamp).toLocaleTimeString(),
                    `"${visitor.firstName} ${visitor.surname}"`,
                    visitor.location,
                    visitor.email,
                    visitor.mobile,
                    feedback.overall,
                    feedback.safety,
                    feedback.responsive,
                    feedback.caring,
                    feedback.leadership,
                    feedback.effectiveness,
                    avgRating.toFixed(1),
                    `"${feedback.additionalComments || 'No comments'}"`
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            return csvContent;
        }

        function showExportFallback(csvContent, recordCount) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;
            `;
            
            content.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #333;">üìÑ Feedback Export (${recordCount} records)</h3>
                <p style="margin-bottom: 15px;">Copy this data and paste it into Excel or Google Sheets:</p>
                <textarea style="width: 100%; height: 300px; font-family: monospace; font-size: 12px; border: 1px solid #ccc; padding: 10px;" readonly>${csvContent}</textarea>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Close</button>
                    <button onclick="navigator.clipboard.writeText(\`${csvContent.replace(/`/g, '\\`')}\`).then(() => alert('Copied to clipboard!'))" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px;">Copy to Clipboard</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Remove the old CSV export function and replace with PDF
        function showExportModal() {
            exportFeedbackPDF();
        }

        function generatePDFContent(feedbackData) {
            const now = new Date();
            const reportDate = now.toLocaleDateString();
            const overallAverage = calculateOverallAverage(feedbackData);
            
            // Calculate category averages
            const categoryAverages = {
                overall: feedbackData.reduce((sum, v) => sum + v.feedback.overall, 0) / feedbackData.length,
                safety: feedbackData.reduce((sum, v) => sum + v.feedback.safety, 0) / feedbackData.length,
                responsive: feedbackData.reduce((sum, v) => sum + v.feedback.responsive, 0) / feedbackData.length,
                caring: feedbackData.reduce((sum, v) => sum + v.feedback.caring, 0) / feedbackData.length,
                leadership: feedbackData.reduce((sum, v) => sum + v.feedback.leadership, 0) / feedbackData.length,
                effectiveness: feedbackData.reduce((sum, v) => sum + v.feedback.effectiveness, 0) / feedbackData.length
            };
            
            // Group by location
            const locationGroups = {};
            feedbackData.forEach(visitor => {
                if (!locationGroups[visitor.location]) {
                    locationGroups[visitor.location] = [];
                }
                locationGroups[visitor.location].push(visitor);
            });
            
            let html = `
<!DOCTYPE html>
<html>
<head>
    <title>Alex Davis Care Group - Feedback Report</title>
    <style>
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 20px; 
            line-height: 1.6;
            color: #333;
        }
        .header { 
            text-align: center; 
            border-bottom: 3px solid #2c3e50; 
            padding-bottom: 20px; 
            margin-bottom: 30px;
        }
        .logo { 
            font-size: 28px; 
            font-weight: bold; 
            color: #2c3e50; 
            margin-bottom: 10px;
        }
        .report-title { 
            font-size: 24px; 
            color: #34495e; 
            margin-bottom: 5px;
        }
        .report-date { 
            color: #7f8c8d; 
            font-size: 14px;
        }
        
        .summary-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 5px solid #3498db;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 15px;
        }
        
        .summary-card {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .summary-number {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .summary-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .category-analysis {
            margin-bottom: 30px;
        }
        
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .category-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .star-display {
            color: #f39c12;
            font-size: 18px;
        }
        
        .location-section {
            page-break-before: auto;
            margin-bottom: 40px;
        }
        
        .location-header {
            background: #34495e;
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .feedback-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .feedback-table th {
            background: #ecf0f1;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: #2c3e50;
            border-bottom: 2px solid #bdc3c7;
        }
        
        .feedback-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 14px;
        }
        
        .feedback-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .rating-cell {
            text-align: center;
            font-weight: bold;
        }
        
        .comments-cell {
            max-width: 200px;
            font-style: italic;
            color: #555;
        }
        
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #bdc3c7;
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
        }
        
        @media print {
            body { margin: 0; }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">Alex Davis Care Group</div>
        <div class="report-title">Visitor Feedback Report</div>
        <div class="report-date">Generated on ${reportDate}</div>
    </div>
    
    <div class="summary-section">
        <h2 style="margin-top: 0; color: #2c3e50;">üìä Executive Summary</h2>
        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-number">${feedbackData.length}</div>
                <div class="summary-label">Total Responses</div>
            </div>
            <div class="summary-card">
                <div class="summary-number">${overallAverage.toFixed(1)}/5.0</div>
                <div class="summary-label">Average Rating</div>
            </div>
            <div class="summary-card">
                <div class="summary-number">${Object.keys(locationGroups).length}</div>
                <div class="summary-label">Locations</div>
            </div>
        </div>
    </div>
    
    <div class="category-analysis">
        <h2 style="color: #2c3e50;">‚≠ê Category Performance</h2>
        <div class="category-item">
            <span class="category-name">Overall Experience</span>
            <span class="star-display">${generateStars(categoryAverages.overall)} (${categoryAverages.overall.toFixed(1)})</span>
        </div>
        <div class="category-item">
            <span class="category-name">Safety</span>
            <span class="star-display">${generateStars(categoryAverages.safety)} (${categoryAverages.safety.toFixed(1)})</span>
        </div>
        <div class="category-item">
            <span class="category-name">Responsiveness</span>
            <span class="star-display">${generateStars(categoryAverages.responsive)} (${categoryAverages.responsive.toFixed(1)})</span>
        </div>
        <div class="category-item">
            <span class="category-name">Caring Approach</span>
            <span class="star-display">${generateStars(categoryAverages.caring)} (${categoryAverages.caring.toFixed(1)})</span>
        </div>
        <div class="category-item">
            <span class="category-name">Leadership</span>
            <span class="star-display">${generateStars(categoryAverages.leadership)} (${categoryAverages.leadership.toFixed(1)})</span>
        </div>
        <div class="category-item">
            <span class="category-name">Effectiveness</span>
            <span class="star-display">${generateStars(categoryAverages.effectiveness)} (${categoryAverages.effectiveness.toFixed(1)})</span>
        </div>
    </div>
`;

            // Add location sections
            Object.keys(locationGroups).forEach(location => {
                const locationFeedback = locationGroups[location];
                const locationAverage = calculateOverallAverage(locationFeedback);
                
                html += `
    <div class="location-section">
        <div class="location-header">
            üè† ${location} - ${locationFeedback.length} responses (Avg: ${locationAverage.toFixed(1)}/5.0)
        </div>
        <table class="feedback-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Visitor</th>
                    <th>Overall</th>
                    <th>Safety</th>
                    <th>Responsive</th>
                    <th>Caring</th>
                    <th>Leadership</th>
                    <th>Effective</th>
                    <th>Comments</th>
                </tr>
            </thead>
            <tbody>
`;
                
                locationFeedback.forEach(visitor => {
                    const feedback = visitor.feedback;
                    html += `
                <tr>
                    <td>${new Date(visitor.timestamp).toLocaleDateString()}</td>
                    <td><strong>${visitor.firstName} ${visitor.surname}</strong></td>
                    <td class="rating-cell">${feedback.overall}/5</td>
                    <td class="rating-cell">${feedback.safety}/5</td>
                    <td class="rating-cell">${feedback.responsive}/5</td>
                    <td class="rating-cell">${feedback.caring}/5</td>
                    <td class="rating-cell">${feedback.leadership}/5</td>
                    <td class="rating-cell">${feedback.effectiveness}/5</td>
                    <td class="comments-cell">${feedback.additionalComments || 'No comments'}</td>
                </tr>
`;
                });
                
                html += `
            </tbody>
        </table>
    </div>
`;
            });
            
            html += `
    <div class="footer">
        <p>This report was generated by HelloHub Visitor Management System</p>
        <p>Alex Davis Care Group - Committed to Excellence in Care</p>
        <p>Report generated on ${now.toLocaleDateString()} at ${now.toLocaleTimeString()}</p>
    </div>
</body>
</html>
`;
            
            return html;
        }

        function exportFeedbackDataDirect(period, format, location) {
            console.log('Exporting:', period, format, location);
            console.log('All visitor data:', allVisitorData);
            
            const filteredFeedback = filterFeedbackByPeriod(period, location);
            console.log('Filtered feedback:', filteredFeedback);
            
            if (filteredFeedback.length === 0) {
                console.log('No feedback found - checking raw data...');
                const visitorDataWithFeedback = allVisitorData.filter(v => v.feedback);
                console.log('Visitors with feedback property:', visitorDataWithFeedback);
                const visitorDataVisitors = allVisitorData.filter(v => v.userType === 'visitor');
                console.log('All visitors:', visitorDataVisitors);
                
                alert(`No feedback data found for the selected criteria.
                
Debug info:
- Total visitors: ${allVisitorData.length}
- Visitors with feedback: ${visitorDataWithFeedback.length}
- All visitor type records: ${visitorDataVisitors.length}
                
Have you submitted any visitor feedback yet?`);
                return;
            }
            
            let csvContent = '';
            
            if (format === 'detailed') {
                csvContent = generateDetailedReport(filteredFeedback);
            } else if (format === 'summary') {
                csvContent = generateSummaryReport(filteredFeedback);
            } else if (format === 'analytics') {
                csvContent = generateAnalyticsReport(filteredFeedback);
            }
            
            console.log('Generated CSV content length:', csvContent.length);
            console.log('CSV preview:', csvContent.substring(0, 200));
            
            try {
                downloadCSV(csvContent, `feedback-${format}-${period}-${new Date().toISOString().split('T')[0]}.csv`);
                alert(`‚úÖ Exported ${filteredFeedback.length} feedback records successfully!`);
            } catch (error) {
                console.error('Download failed:', error);
                alert('Download failed. Check console for details.');
            }
        }

        function hideExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        function updateExportPreview() {
            const periodEl = document.getElementById('exportPeriod');
            const formatEl = document.getElementById('exportFormat');
            const locationEl = document.getElementById('exportLocation');
            const previewDiv = document.getElementById('exportPreview');
            
            // Check if elements exist before using them
            if (!periodEl || !formatEl || !locationEl || !previewDiv) {
                console.log('Export elements not ready yet');
                return;
            }
            
            const period = periodEl.value;
            const format = formatEl.value;
            const location = locationEl.value;
            
            const filteredFeedback = filterFeedbackByPeriod(period, location);
            
            previewDiv.innerHTML = `
                <strong>Export Preview:</strong><br>
                üìÖ Period: ${getPeriodDescription(period)}<br>
                üìç Location: ${location || 'All Locations'}<br>
                üìä Format: ${format.charAt(0).toUpperCase() + format.slice(1)} Report<br>
                üìù Records: ${filteredFeedback.length} feedback submissions<br>
                ‚≠ê Average Rating: ${filteredFeedback.length > 0 ? calculateOverallAverage(filteredFeedback).toFixed(1) : 'N/A'}/5.0
            `;
        }

        function getPeriodDescription(period) {
            const descriptions = {
                'today': "Today's feedback",
                'week': 'This week (last 7 days)',
                'month': 'This month',
                'quarter': 'This quarter (last 3 months)',
                'year': 'This year',
                'all': 'All time'
            };
            return descriptions[period] || period;
        }

        function filterFeedbackByPeriod(period, location) {
            const now = new Date();
            const feedbackData = allVisitorData.filter(visitor => 
                visitor.userType === 'visitor' && 
                visitor.feedback &&
                (location === '' || visitor.location === location)
            );

            switch(period) {
                case 'today':
                    const today = now.toDateString();
                    return feedbackData.filter(visitor => 
                        new Date(visitor.timestamp).toDateString() === today
                    );
                
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return feedbackData.filter(visitor => 
                        new Date(visitor.timestamp) >= weekAgo
                    );
                
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    return feedbackData.filter(visitor => 
                        new Date(visitor.timestamp) >= monthStart
                    );
                
                case 'quarter':
                    const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    return feedbackData.filter(visitor => 
                        new Date(visitor.timestamp) >= quarterStart
                    );
                
                case 'year':
                    const yearStart = new Date(now.getFullYear(), 0, 1);
                    return feedbackData.filter(visitor => 
                        new Date(visitor.timestamp) >= yearStart
                    );
                
                default:
                    return feedbackData;
            }
        }

        function calculateOverallAverage(feedbackData) {
            if (feedbackData.length === 0) return 0;
            
            const totalAverage = feedbackData.reduce((sum, visitor) => {
                return sum + calculateAverageRating(visitor.feedback);
            }, 0);
            
            return totalAverage / feedbackData.length;
        }

        function exportFeedbackData() {
            const periodEl = document.getElementById('exportPeriod');
            const formatEl = document.getElementById('exportFormat');
            const locationEl = document.getElementById('exportLocation');
            
            // Check if elements exist
            if (!periodEl || !formatEl || !locationEl) {
                alert('Export form not ready. Please try again.');
                return;
            }
            
            const period = periodEl.value;
            const format = formatEl.value;
            const location = locationEl.value;
            
            const filteredFeedback = filterFeedbackByPeriod(period, location);
            
            if (filteredFeedback.length === 0) {
                alert('No feedback data found for the selected criteria.');
                return;
            }
            
            let csvContent = '';
            
            if (format === 'detailed') {
                csvContent = generateDetailedReport(filteredFeedback);
            } else if (format === 'summary') {
                csvContent = generateSummaryReport(filteredFeedback);
            } else if (format === 'analytics') {
                csvContent = generateAnalyticsReport(filteredFeedback);
            }
            
            downloadCSV(csvContent, `feedback-${format}-${period}-${new Date().toISOString().split('T')[0]}.csv`);
            hideExportModal();
            
            showMessage(`‚úÖ Exported ${filteredFeedback.length} feedback records successfully!`, 'success');
        }

        function generateDetailedReport(feedbackData) {
            const headers = [
                'Date', 'Time', 'Visitor Name', 'Location', 'Email', 'Mobile',
                'Overall Rating', 'Safety Rating', 'Responsive Rating', 'Caring Rating', 
                'Leadership Rating', 'Effectiveness Rating', 'Average Rating', 'Additional Comments'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            feedbackData.forEach(visitor => {
                const feedback = visitor.feedback;
                const avgRating = calculateAverageRating(feedback);
                
                const row = [
                    new Date(visitor.timestamp).toLocaleDateString(),
                    new Date(visitor.timestamp).toLocaleTimeString(),
                    `"${visitor.firstName} ${visitor.surname}"`,
                    visitor.location,
                    visitor.email,
                    visitor.mobile,
                    feedback.overall,
                    feedback.safety,
                    feedback.responsive,
                    feedback.caring,
                    feedback.leadership,
                    feedback.effectiveness,
                    avgRating.toFixed(1),
                    `"${feedback.additionalComments || 'No comments'}"`
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            return csvContent;
        }

        function generateSummaryReport(feedbackData) {
            const headers = [
                'Date', 'Visitor Name', 'Location', 'Average Rating', 'Key Comments'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            feedbackData.forEach(visitor => {
                const feedback = visitor.feedback;
                const avgRating = calculateAverageRating(feedback);
                
                const row = [
                    new Date(visitor.timestamp).toLocaleDateString(),
                    `"${visitor.firstName} ${visitor.surname}"`,
                    visitor.location,
                    avgRating.toFixed(1),
                    `"${feedback.additionalComments || 'No additional comments'}"`
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            return csvContent;
        }

        function generateAnalyticsReport(feedbackData) {
            const locationStats = {};
            const ratingBreakdown = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            
            feedbackData.forEach(visitor => {
                const location = visitor.location;
                const feedback = visitor.feedback;
                const avgRating = calculateAverageRating(feedback);
                
                if (!locationStats[location]) {
                    locationStats[location] = {
                        count: 0,
                        totalRating: 0,
                        overall: 0,
                        safety: 0,
                        responsive: 0,
                        caring: 0,
                        leadership: 0,
                        effectiveness: 0
                    };
                }
                
                locationStats[location].count++;
                locationStats[location].totalRating += avgRating;
                locationStats[location].overall += feedback.overall;
                locationStats[location].safety += feedback.safety;
                locationStats[location].responsive += feedback.responsive;
                locationStats[location].caring += feedback.caring;
                locationStats[location].leadership += feedback.leadership;
                locationStats[location].effectiveness += feedback.effectiveness;
                
                // Count rating distribution
                const roundedRating = Math.round(avgRating);
                if (roundedRating >= 1 && roundedRating <= 5) {
                    ratingBreakdown[roundedRating]++;
                }
            });
            
            let csvContent = 'ALEX DAVIS CARE GROUP - FEEDBACK ANALYTICS REPORT\n';
            csvContent += `Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}\n`;
            csvContent += `Total Feedback Submissions: ${feedbackData.length}\n\n`;
            
            csvContent += 'LOCATION BREAKDOWN\n';
            csvContent += 'Location,Count,Avg Rating,Overall,Safety,Responsive,Caring,Leadership,Effectiveness\n';
            
            Object.keys(locationStats).forEach(location => {
                const stats = locationStats[location];
                const row = [
                    location,
                    stats.count,
                    (stats.totalRating / stats.count).toFixed(1),
                    (stats.overall / stats.count).toFixed(1),
                    (stats.safety / stats.count).toFixed(1),
                    (stats.responsive / stats.count).toFixed(1),
                    (stats.caring / stats.count).toFixed(1),
                    (stats.leadership / stats.count).toFixed(1),
                    (stats.effectiveness / stats.count).toFixed(1)
                ];
                csvContent += row.join(',') + '\n';
            });
            
            csvContent += '\nRATING DISTRIBUTION\n';
            csvContent += 'Rating,Count,Percentage\n';
            Object.keys(ratingBreakdown).forEach(rating => {
                const count = ratingBreakdown[rating];
                const percentage = ((count / feedbackData.length) * 100).toFixed(1);
                csvContent += `${rating} Stars,${count},${percentage}%\n`;
            });
            
            return csvContent;
        }

        function downloadCSV(csvContent, filename) {
            console.log('downloadCSV called with filename:', filename);
            console.log('CSV content length:', csvContent.length);
            
            // Since we're in an artifact environment, just show the CSV data directly
            console.log('Showing CSV data in alert...');
            
            // Create a formatted display of the CSV
            const lines = csvContent.split('\n');
            const header = lines[0];
            const dataLines = lines.slice(1, 6); // Show first 5 data lines
            
            let displayText = `Feedback Export Complete! (${filename})
            
COPY THIS DATA AND PASTE INTO EXCEL:

${header}
`;
            
            dataLines.forEach(line => {
                if (line.trim()) {
                    displayText += line + '\n';
                }
            });
            
            if (lines.length > 6) {
                displayText += `... and ${lines.length - 6} more rows`;
            }
            
            displayText += `

INSTRUCTIONS:
1. Copy the text above (Ctrl+C / Cmd+C)
2. Open Excel or Google Sheets
3. Paste the data (Ctrl+V / Cmd+V)
4. Save as: ${filename}`;
            
            alert(displayText);
            
            // Also try to copy to clipboard
            try {
                navigator.clipboard.writeText(csvContent).then(() => {
                    console.log('CSV data copied to clipboard');
                    setTimeout(() => {
                        alert('‚úÖ CSV data has also been copied to your clipboard!\n\nJust paste it directly into Excel.');
                    }, 1000);
                });
            } catch (e) {
                console.log('Clipboard copy failed:', e);
            }
        }

        // Add event listeners for export preview updates
        document.addEventListener('DOMContentLoaded', function() {
            const exportSelects = ['exportPeriod', 'exportFormat', 'exportLocation'];
            exportSelects.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateExportPreview);
                }
            });
        });

        function silentRefresh() {
            const rawData = localStorage.getItem('hellohubVisitors');
            const newData = JSON.parse(rawData || '[]');
            
            if (newData.length !== allVisitorData.length) {
                allVisitorData = newData.map(visitor => ({
                    ...visitor,
                    timestamp: new Date(visitor.timestamp)
                }));
                displayVisitorData();
                updateStats();
                updateRecentActivity();
            }
        }

        setInterval(() => silentRefresh(), ADMIN_CONFIG.refreshInterval);

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè¢ Admin Dashboard initialized');
            loadVisitorData();
        });
    </script>
</body>
</html>,
